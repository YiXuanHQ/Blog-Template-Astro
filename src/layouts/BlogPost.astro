---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import TableOfContents from '../components/TableOfContents.astro';
import { generateBreadcrumb, type BreadcrumbItem } from '../utils/breadcrumb';
import { WALINE_SERVER_URL } from '../consts';

type Props = CollectionEntry<'blog'>['data'] & {
	backUrl?: string;
	parentPath?: string;
	showPageview?: boolean;
	categories?: string[];
	breadcrumbItems?: BreadcrumbItem[];
};

const { title, description, pubDate, updatedDate, heroImage, tags = [], categories = [], backUrl = '/', parentPath, showPageview = false, breadcrumbItems: customBreadcrumbItems } = Astro.props;

function normalizePath(pathname: string) {
	// 统一为“带尾随 /”的路径，避免 /post 与 /post/ 形成两套浏览量计数
	if (pathname === '/') return '/';
	return pathname.endsWith('/') ? pathname : `${pathname}/`;
}

const normalizedPathname = normalizePath(Astro.url.pathname);

// 生成面包屑导航（如果未传入自定义面包屑）
const currentPath = Astro.url.pathname;
let breadcrumbItems: BreadcrumbItem[] = customBreadcrumbItems || [];
if (!customBreadcrumbItems) {
	let breadcrumbType: 'tutorial' | 'article' | 'note' = 'article';
	if (currentPath.startsWith('/tutorials/')) {
		breadcrumbType = 'tutorial';
	} else if (currentPath.startsWith('/notes/')) {
		breadcrumbType = 'note';
	}
	breadcrumbItems = generateBreadcrumb(currentPath, title, breadcrumbType);
}
---

<html lang="zh-CN">
	<head>
		<BaseHead title={title} description={description} />
		<style>
			main {
				/* 博客详情页放宽阅读区域，同时保留两侧留白 */
				width: min(1320px, 100% - 2rem);
				max-width: none;
				margin: 0 auto;
			}
			.article {
				display: grid;
				grid-template-columns: minmax(0, 1fr);
				gap: 1.5rem;
				margin-top: 1.5rem;
			}
			.article-content {
				display: grid;
				grid-template-columns: 1fr 280px;
				gap: 2rem;
				align-items: start;
			}
			.toc-sidebar {
				position: sticky;
				top: 100px;
			}
			@media (max-width: 1024px) {
				.article-content {
					grid-template-columns: 1fr;
				}
				.toc-sidebar {
					position: relative;
					top: 0;
				}
			}
			.hero-image {
				width: 100%;
				margin-top: 0.5rem;
				border-radius: var(--radius-card);
				overflow: hidden;
				box-shadow: var(--shadow-card);
				transition: transform 0.3s ease, box-shadow 0.3s ease;
			}
			
			.hero-image:hover {
				transform: translateY(-4px);
				box-shadow: 0 18px 48px rgba(93, 103, 232, 0.2);
			}
			
			.hero-image img {
				width: 100%;
				height: auto;
				display: block;
				border-radius: var(--radius-card);
			}
			.article-header {
				display: flex;
				flex-direction: column;
				gap: 1.25rem;
				align-items: flex-start;
				margin-bottom: 2rem;
				padding-bottom: 2rem;
				border-bottom: 2px solid var(--color-border);
			}
			
			.article-header h1 {
				font-size: clamp(1.75rem, 3vw, 2.25rem);
				font-weight: 700;
				line-height: 1.3;
				letter-spacing: -0.02em;
				margin: 0;
				color: var(--color-text);
			}
			
			.article-header .description {
				font-size: 1.125rem;
				line-height: 1.7;
				color: var(--color-muted);
				margin: 0;
			}
			
			.meta {
				display: flex;
				align-items: center;
				gap: 0.75rem;
				flex-wrap: wrap;
				margin-top: 0.5rem;
			}
			
			.meta-item {
				display: inline-flex;
				align-items: center;
				gap: 0.4rem;
				font-size: 0.9375rem;
				color: var(--color-muted);
			}
			
			.meta-text {
				color: var(--color-muted);
			}
			
			.meta-icon {
				width: 16px;
				height: 16px;
				opacity: 0.7;
				flex-shrink: 0;
			}
			
			.tags {
				display: flex;
				gap: 0.5rem;
				flex-wrap: wrap;
				margin-top: 0;
			}
			
			.article-header .tag {
				font-size: 0.875rem;
				padding: 0.4rem 0.875rem;
				border-radius: var(--radius-pill);
				background: linear-gradient(135deg, rgba(93, 103, 232, 0.12), rgba(93, 103, 232, 0.08));
				border: 1px solid rgba(93, 103, 232, 0.2);
				color: var(--color-primary-dark);
				font-weight: 500;
				transition: all 0.2s ease;
			}
			
			.article-header .tag:hover {
				background: linear-gradient(135deg, rgba(93, 103, 232, 0.18), rgba(93, 103, 232, 0.12));
				border-color: rgba(93, 103, 232, 0.3);
				transform: translateY(-1px);
				box-shadow: 0 2px 8px rgba(93, 103, 232, 0.15);
			}
			.prose {
				background: var(--color-surface);
				border: 1px solid var(--color-border);
				border-radius: var(--radius-card);
				padding: 2rem 2rem;
				box-shadow: var(--shadow-soft);
				max-width: 100%;
				width: 100%;
				overflow-wrap: break-word;
				word-wrap: break-word;
			}
			/* 限制文章内容区域的最大宽度，使其适合阅读 */
			.article-content > .prose {
				/* 放宽正文最大宽度，提升桌面端阅读体验 */
				max-width: 960px;
			}
			@media (max-width: 1024px) {
				.article-content > .prose {
					max-width: 100%;
				}
			}
			@media (max-width: 768px) {
				.prose {
					padding: 1.5rem 1.25rem;
				}
			}
			.updated {
				color: var(--color-muted);
				font-size: 0.875rem;
			}
			
			@media (max-width: 768px) {
				.article-header {
					gap: 1rem;
					margin-bottom: 1.5rem;
					padding-bottom: 1.5rem;
				}
				
				.article-header h1 {
					font-size: clamp(1.5rem, 5vw, 1.875rem);
				}
				
				.article-header .description {
					font-size: 1rem;
				}
				
				.meta {
					gap: 0.625rem;
				}
				
				.tags {
					gap: 0.4rem;
				}
			}
			@media (max-width: 720px) {
				main {
					max-width: calc(100% - 1.5rem);
				}
			}
		</style>
	</head>

	<body>
		<Header />
		<main>
			<article class="article">
				<div class="article-header">
					<Breadcrumb items={breadcrumbItems} />
					<h1>{title}</h1>
					{description && <p class="description">{description}</p>}
					<div class="meta">
						<div class="meta-item">
							<svg class="meta-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
								<line x1="16" y1="2" x2="16" y2="6"></line>
								<line x1="8" y1="2" x2="8" y2="6"></line>
								<line x1="3" y1="10" x2="21" y2="10"></line>
							</svg>
							<span class="meta-text">
								<FormattedDate date={pubDate} />
							</span>
						</div>
						{categories.length > 0 && (
							<div class="meta-item">
								<svg class="meta-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<path d="M3 7a2 2 0 0 1 2-2h4l2 2h8a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"></path>
								</svg>
								<span class="meta-text">{categories.join(' ')}</span>
							</div>
						)}
						{tags.length > 0 && (
							<div class="meta-item">
								<svg class="meta-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
									<line x1="7" y1="7" x2="7.01" y2="7"></line>
								</svg>
								<span class="meta-text">{tags.join(' ')}</span>
							</div>
						)}
						{updatedDate && (
							<div class="meta-item">
								<svg class="meta-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
									<circle cx="12" cy="12" r="3"></circle>
								</svg>
								<span class="updated">更新于 <FormattedDate date={updatedDate} /></span>
							</div>
						)}
						{showPageview && (
							<div class="meta-item">
								<svg class="meta-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
									<circle cx="12" cy="12" r="3"></circle>
								</svg>
								<span class="meta-text">
									<span class="waline-pageview-count" data-path={normalizedPathname} data-server-url={WALINE_SERVER_URL}>-</span>
								</span>
							</div>
						)}
					</div>
					<div class="hero-image">
						{heroImage && <Image width={1200} height={560} src={heroImage} alt={title} />}
					</div>
				</div>
				<div class="article-content">
					<div class="prose">
						<slot />
					</div>
					<aside class="toc-sidebar">
						<TableOfContents />
					</aside>
				</div>
			</article>
		</main>
		<Footer />
		<script>
			// 为代码块添加终端窗口样式和复制功能
			function initCodeCopyButtons() {
				// 支持普通 pre 和 Shiki 的 .astro-code
				const codeBlocks = document.querySelectorAll('.prose pre, .prose .astro-code, pre, .astro-code');
				
				codeBlocks.forEach((pre) => {
					// 如果已经有包装器，跳过
					if (pre.parentElement?.classList.contains('code-block-wrapper')) {
						return;
					}
					
					// 创建包装器
					const wrapper = document.createElement('div');
					wrapper.className = 'code-block-wrapper';
					
					// 创建终端窗口标题栏
					const header = document.createElement('div');
					header.className = 'code-block-header';
					
					// 创建圆点按钮组
					const dots = document.createElement('div');
					dots.className = 'code-block-dots';
					
					const closeDot = document.createElement('div');
					closeDot.className = 'code-block-dot close';
					closeDot.setAttribute('aria-label', '关闭');
					
					const minimizeDot = document.createElement('div');
					minimizeDot.className = 'code-block-dot minimize';
					minimizeDot.setAttribute('aria-label', '最小化');
					
					const maximizeDot = document.createElement('div');
					maximizeDot.className = 'code-block-dot maximize';
					maximizeDot.setAttribute('aria-label', '最大化');
					
					dots.appendChild(closeDot);
					dots.appendChild(minimizeDot);
					dots.appendChild(maximizeDot);
					
					// 创建标题（显示语言名称）
					const title = document.createElement('div');
					title.className = 'code-block-title';
					const code = pre.querySelector('code');
					const lang = code?.className?.match(/language-(\w+)/)?.[1] || 'code';
					title.textContent = lang;
					
					// 创建复制按钮
					const copyBtn = document.createElement('button');
					copyBtn.className = 'code-copy-btn';
					copyBtn.setAttribute('aria-label', '复制代码');
					copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
					
					// 组装标题栏
					header.appendChild(dots);
					header.appendChild(title);
					header.appendChild(copyBtn);
					
					// 获取代码内容
					const codeText = code ? code.textContent || '' : pre.textContent || '';
					
					// 复制功能
					copyBtn.addEventListener('click', async (e) => {
						e.stopPropagation();
						try {
							await navigator.clipboard.writeText(codeText);
							copyBtn.classList.add('copied');
							copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
							
							setTimeout(() => {
								copyBtn.classList.remove('copied');
								copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
							}, 2000);
						} catch (err) {
							console.error('复制失败:', err);
							// 降级方案：使用传统方法
							const textArea = document.createElement('textarea');
							textArea.value = codeText;
							textArea.style.position = 'fixed';
							textArea.style.opacity = '0';
							document.body.appendChild(textArea);
							textArea.select();
							try {
								document.execCommand('copy');
								copyBtn.classList.add('copied');
								copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
								setTimeout(() => {
									copyBtn.classList.remove('copied');
									copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
								}, 2000);
							} catch (fallbackErr) {
								console.error('降级复制也失败:', fallbackErr);
							}
							document.body.removeChild(textArea);
						}
					});
					
					// 包装 pre 元素
					pre.parentNode?.insertBefore(wrapper, pre);
					wrapper.appendChild(header);
					wrapper.appendChild(pre);
				});
			}
			
			// 页面加载完成后初始化
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', initCodeCopyButtons);
			} else {
				initCodeCopyButtons();
			}
			
			// 监听内容变化，重新初始化（以防内容动态加载）
			const observer = new MutationObserver(() => {
				initCodeCopyButtons();
			});
			
			observer.observe(document.querySelector('.prose') || document.body, {
				childList: true,
				subtree: true
			});
		</script>
		{showPageview && (
			// 使用官方 CDN，避免本地打包产物在部署环境下路径/缓存导致的加载异常
			<script is:inline type="module">
				import { pageviewCount } from 'https://cdn.jsdelivr.net/npm/@waline/client@v3/dist/waline.js';

				function initWalinePageviewCounts() {
					const nodes = document.querySelectorAll('.waline-pageview-count');
					if (!nodes.length) return;

					const serverURL = nodes[0].dataset.serverUrl || '';
					if (!serverURL) return;

					pageviewCount({
						serverURL,
						selector: '.waline-pageview-count',
						update: true,
						lang: navigator.language,
					});
				}

				if (document.readyState === 'loading') {
					document.addEventListener('DOMContentLoaded', initWalinePageviewCounts);
				} else {
					initWalinePageviewCounts();
				}
			</script>
		)}
	</body>
</html>
