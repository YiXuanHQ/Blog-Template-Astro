---
title: 函数详解
nextChapter: "java-backend/mysql/第02章-进阶篇/02-约束与数据完整性"
parentChapter: "java-backend/mysql/README"
---
# 函数详解

> MySQL提供了丰富的内置函数，帮助我们更高效地处理数据。本章将详细介绍常用函数的使用方法和应用场景，掌握函数是提升SQL开发效率的关键。

## ⚡ 快速参考

- **字符串函数**：CONCAT、SUBSTRING、REPLACE、TRIM、LOWER、UPPER、LPAD、RPAD
- **数值函数**：CEIL、FLOOR、ROUND、MOD、ABS、RAND
- **日期函数**：NOW、CURDATE、CURTIME、YEAR、MONTH、DAY、DATE_ADD、DATEDIFF、DATE_FORMAT
- **流程函数**：IF、IFNULL、CASE WHEN（条件判断和流程控制）
- **函数分类**：字符串处理、数值计算、日期时间、条件判断

## 📚 学习目标

1. 掌握MySQL常用字符串函数的使用方法和应用场景
2. 熟练使用数值函数进行数学计算和数据处理
3. 掌握日期时间函数的用法，能够进行日期计算和格式化
4. 理解流程函数的作用，能够使用IF和CASE实现条件判断
5. 能够根据业务需求选择合适的函数组合使用
6. 理解函数在实际业务场景中的应用（如计算入职天数、分数等级判定等）

## 函数概述

### 什么是函数？

**函数**是指一段可以直接被另一段程序调用的程序或代码。也就意味着，这一段程序或代码在MySQL中已经给我们提供了，我们要做的就是在合适的业务场景调用对应的函数完成对应的业务需求即可。

### 函数的使用场景

**场景1：计算入职天数**

在企业的OA或其他的人力系统中，经常会提供的有这样一个功能，每一个员工登录上来之后都能够看到当前员工入职的天数。而在数据库中，存储的都是入职日期，如 2000-11-12，那如何快速计算出天数呢？

**场景2：分数等级判定**

在做报表这类的业务需求中，我们要展示出学员的分数等级分布。而在数据库中，存储的是学生的分数值，如98/75，如何快速判定分数的等级呢？

其实，上述的这一类的需求呢，我们通过MySQL中的函数都可以很方便的实现。

### 函数的分类

MySQL中的函数主要分为以下四类：

1. **字符串函数**：处理字符串数据
2. **数值函数**：处理数值计算
3. **日期函数**：处理日期时间
4. **流程函数**：实现条件判断和流程控制

---

## 一、字符串函数

### 1.1 常用字符串函数

| 函数 | 说明 | 示例 |
|------|------|------|
| `CONCAT(s1,s2,...)` | 字符串拼接 | `CONCAT('Hello', 'World')` → 'HelloWorld' |
| `CONCAT_WS(sep,s1,s2,...)` | 带分隔符拼接 | `CONCAT_WS('-','2024','01','01')` → '2024-01-01' |
| `LOWER(str)` | 转小写 | `LOWER('HELLO')` → 'hello' |
| `UPPER(str)` | 转大写 | `UPPER('hello')` → 'HELLO' |
| `LENGTH(str)` | 字符串长度（字节） | `LENGTH('你好')` → 6 |
| `CHAR_LENGTH(str)` | 字符串长度（字符） | `CHAR_LENGTH('你好')` → 2 |
| `TRIM(str)` | 去除首尾空格 | `TRIM(' hello ')` → 'hello' |
| `LTRIM(str)` | 去除左侧空格 | `LTRIM(' hello')` → 'hello' |
| `RTRIM(str)` | 去除右侧空格 | `RTRIM('hello ')` → 'hello' |
| `SUBSTRING(str,pos,len)` | 截取子串 | `SUBSTRING('hello',2,3)` → 'ell' |
| `REPLACE(str,old,new)` | 替换字符串 | `REPLACE('hello','l','L')` → 'heLLo' |
| `LPAD(str,len,pad)` | 左填充 | `LPAD('5',3,'0')` → '005' |
| `RPAD(str,len,pad)` | 右填充 | `RPAD('5',3,'0')` → '500' |
| `REVERSE(str)` | 反转字符串 | `REVERSE('hello')` → 'olleh' |
| `INSTR(str,substr)` | 查找子串位置 | `INSTR('hello','ll')` → 3 |

MySQL中内置了很多字符串函数，常用的几个如下：

| 函数                       | 功能                                                      |
| -------------------------- | --------------------------------------------------------- |
| `CONCAT(S1,S2,...Sn)`      | 字符串拼接，将S1，S2，... Sn拼接成一个字符串              |
| `LOWER(str)`               | 将字符串str全部转为小写                                   |
| `UPPER(str)`               | 将字符串str全部转为大写                                   |
| `LPAD(str,n,pad)`          | 左填充，用字符串pad对str的左边进行填充，达到n个字符串长度 |
| `RPAD(str,n,pad)`          | 右填充，用字符串pad对str的右边进行填充，达到n个字符串长度 |
| `TRIM(str)`                | 去掉字符串头部和尾部的空格                                |
| `SUBSTRING(str,start,len)` | 返回从字符串str从start位置起的len个长度的字符串           |

### 1.2 函数演示

**A. CONCAT：字符串拼接**

```sql
-- 字符串拼接：将多个字符串连接在一起
SELECT CONCAT('Hello', ' MySQL');  
-- 结果：'Hello MySQL'

-- 拼接字段值
SELECT CONCAT('姓名：', name, '，年龄：', age) AS info 
FROM employees;
```

**B. LOWER：全部转小写**

```sql
-- 将字符串转换为小写
SELECT LOWER('Hello');  
-- 结果：'hello'

-- 应用：统一邮箱格式
SELECT LOWER(email) AS email_lower FROM users;
```

**C. UPPER：全部转大写**

```sql
-- 将字符串转换为大写
SELECT UPPER('Hello');  
-- 结果：'HELLO'

-- 应用：统一用户名格式
SELECT UPPER(username) AS username_upper FROM users;
```

**D. LPAD：左填充**

```sql
-- 左填充：用指定字符在左侧填充到指定长度
SELECT LPAD('01', 5, '-');  
-- 结果：'---01'

-- 用0填充（常用于工号、订单号格式化）
SELECT LPAD('1', 5, '0');  
-- 结果：'00001'
```

**E. RPAD：右填充**

```sql
-- 右填充：用指定字符在右侧填充到指定长度
SELECT RPAD('01', 5, '-');  
-- 结果：'01---'
```

**F. TRIM：去除空格**

```sql
-- 去除字符串头部和尾部的空格
SELECT TRIM(' Hello MySQL ');  
-- 结果：'Hello MySQL'

-- 去除用户输入的空格
SELECT TRIM(name) AS name_trimmed FROM users;
```

**G. SUBSTRING：截取子字符串**

```sql
-- 截取子字符串：从start位置开始，截取len个字符
SELECT SUBSTRING('Hello MySQL', 1, 5);  
-- 结果：'Hello'

-- 从指定位置截取到末尾
SELECT SUBSTRING('Hello MySQL', 7);  
-- 结果：'MySQL'
```

### 1.3 示例演示

```sql
-- 1. 字符串拼接
SELECT CONCAT('姓名：', name, '，年龄：', age) AS info 
FROM employees;

-- 使用分隔符拼接
SELECT CONCAT_WS(' - ', name, department, position) AS employee_info 
FROM employees;

-- 2. 大小写转换
SELECT 
    UPPER(name) AS uppercase_name,
    LOWER(email) AS lowercase_email
FROM users;

-- 3. 去除空格
SELECT TRIM('  hello world  ') AS trimmed;  -- 'hello world'

-- 4. 字符串截取
SELECT SUBSTRING('Hello World', 1, 5);  -- 'Hello'
SELECT SUBSTRING('Hello World', 7);     -- 'World'

-- 5. 字符串替换
SELECT REPLACE('www.mysql.com', 'mysql', 'baidu');  -- 'www.baidu.com'

-- 6. 左右填充（格式化数字）
SELECT LPAD(id, 6, '0') AS formatted_id FROM orders;
-- 1 → '000001'
-- 123 → '000123'

-- 7. 查找子串
SELECT name FROM users WHERE INSTR(email, '@gmail.com') > 0;
```

### 1.4 应用案例：工号补零

![image-20260111175222625](https://raw.gitcode.com/YiXuanHQ/YiXuan-Blog-Image/raw/main/tutorials/java-backend/mysql/image-20260111175222625.png)

**业务需求**：由于业务需求变更，企业员工的工号，统一为5位数，目前不足5位数的全部在前面补0。比如：1号员工的工号应该为00001。

**解决方案**：使用LPAD函数进行左填充。

```sql
-- 更新工号，不足5位的前面补0
UPDATE emp SET workno = LPAD(workno, 5, '0');
```

**处理前：**

```
workno: 1
workno: 12
workno: 123
```

**处理后：**

```
workno: 00001
workno: 00012
workno: 00123
```

![image-20260111175311003](https://raw.gitcode.com/YiXuanHQ/YiXuan-Blog-Image/raw/main/tutorials/java-backend/mysql/image-20260111175311003.png)

### 1.5 实际应用案例

```sql
-- 案例1：手机号码脱敏
SELECT 
    name,
    CONCAT(
        SUBSTRING(phone, 1, 3),
        '****',
        SUBSTRING(phone, 8, 4)
    ) AS masked_phone
FROM users;
-- 13812345678 → 138****5678

-- 案例2：生成订单编号
SELECT 
    CONCAT(
        'ORD',
        DATE_FORMAT(NOW(), '%Y%m%d'),
        LPAD(id, 6, '0')
    ) AS order_no
FROM orders;
-- ORD20240101000123

-- 案例3：邮箱域名统计
SELECT 
    SUBSTRING(email, INSTR(email, '@') + 1) AS domain,
    COUNT(*) AS user_count
FROM users
GROUP BY domain;
```

---

## 二、数值函数

### 2.1 常用数值函数

| 函数 | 说明 | 示例 |
|------|------|------|
| `ABS(x)` | 绝对值 | `ABS(-5)` → 5 |
| `CEIL(x)` | 向上取整 | `CEIL(1.1)` → 2 |
| `FLOOR(x)` | 向下取整 | `FLOOR(1.9)` → 1 |
| `ROUND(x,d)` | 四舍五入 | `ROUND(3.1415, 2)` → 3.14 |
| `TRUNCATE(x,d)` | 截断小数 | `TRUNCATE(3.1415, 2)` → 3.14 |
| `MOD(x,y)` | 取模（余数） | `MOD(10, 3)` → 1 |
| `POWER(x,y)` | 幂运算 | `POWER(2, 3)` → 8 |
| `SQRT(x)` | 平方根 | `SQRT(16)` → 4 |
| `RAND()` | 随机数(0-1) | `RAND()` → 0.xxxxx |
| `SIGN(x)` | 符号 | `SIGN(-5)` → -1 |

### 2.2 函数演示

**A. CEIL：向上取整**

```sql
-- 向上取整：返回大于或等于指定数值的最小整数
SELECT CEIL(1.1);   -- 结果：2
SELECT CEIL(1.9);   -- 结果：2
SELECT CEIL(-5.1);  -- 结果：-5
```

**B. FLOOR：向下取整**

```sql
-- 向下取整：返回小于或等于指定数值的最大整数
SELECT FLOOR(1.9);   -- 结果：1
SELECT FLOOR(1.1);   -- 结果：1
SELECT FLOOR(-5.1);  -- 结果：-6
```

**C. MOD：取模**

```sql
-- 取模运算：返回x除以y的余数
SELECT MOD(7, 4);   -- 结果：3（7除以4余3）
SELECT 7 % 4;       -- 结果：3（同上，使用%运算符）
SELECT MOD(10, 3);  -- 结果：1
```

**D. RAND：获取随机数**

```sql
-- 获取0-1之间的随机数
SELECT RAND();  
-- 结果：0.xxxxx（每次执行结果不同）
```

**E. ROUND：四舍五入**

```sql
-- 四舍五入：保留指定小数位数
SELECT ROUND(2.344, 2);   -- 结果：2.34
SELECT ROUND(3.1415);     -- 结果：3（默认保留0位小数）
SELECT ROUND(3.1415, 2);  -- 结果：3.14
SELECT ROUND(3.1415, 3);  -- 结果：3.142
```

### 2.3 示例演示

```sql
-- 1. 绝对值
SELECT ABS(-100);  -- 100

-- 2. 向上取整
SELECT CEIL(5.1);   -- 6
SELECT CEIL(5.9);   -- 6
SELECT CEIL(-5.1);  -- -5

-- 3. 向下取整
SELECT FLOOR(5.1);   -- 5
SELECT FLOOR(5.9);   -- 5
SELECT FLOOR(-5.1);  -- -6

-- 4. 四舍五入
SELECT ROUND(3.1415);       -- 3
SELECT ROUND(3.1415, 2);    -- 3.14
SELECT ROUND(3.1415, 3);    -- 3.142

-- 5. 取模运算
SELECT MOD(10, 3);  -- 1（10除以3余1）
SELECT 10 % 3;      -- 1（同上）

-- 6. 随机数
SELECT RAND();                    -- 0.xxxxx
SELECT RAND() * 100;              -- 0-100之间
SELECT FLOOR(RAND() * 100);       -- 0-99之间的整数
SELECT FLOOR(RAND() * 100) + 1;   -- 1-100之间的整数
```

### 2.4 应用案例：生成六位数随机验证码

**业务需求**：通过数据库的函数，生成一个六位数的随机验证码。

**思路**：
1. 获取随机数可以通过 `RAND()` 函数
2. 但是获取出来的随机数是在0-1之间的，所以可以在其基础上乘以1000000
3. 然后使用 `ROUND()` 舍弃小数部分
4. 如果长度不足6位，使用 `LPAD()` 补0

```sql
-- 生成六位数随机验证码
SELECT LPAD(ROUND(RAND() * 1000000, 0), 6, '0') AS verification_code;
-- 结果示例：'123456'、'000789'、'045678'
```

**步骤拆解：**

```sql
-- 1. 生成0-1之间的随机数
SELECT RAND();
-- 示例：0.123456789

-- 2. 乘以1000000，得到0-1000000之间的随机数
SELECT RAND() * 1000000;
-- 示例：123456.789

-- 3. 使用ROUND舍弃小数部分
SELECT ROUND(RAND() * 1000000, 0);
-- 示例：123457（可能不足6位）

-- 4. 使用LPAD左填充，确保6位数
SELECT LPAD(ROUND(RAND() * 1000000, 0), 6, '0');
-- 示例：'123457'、'000789'
```

### 2.5 实际应用案例

```sql
-- 案例1：价格计算（保留两位小数）
SELECT 
    product_name,
    price,
    ROUND(price * 0.8, 2) AS discount_price
FROM products;

-- 案例2：随机抽取10个用户
SELECT * FROM users 
ORDER BY RAND() 
LIMIT 10;

-- 案例3：计算商品评分
SELECT 
    product_id,
    ROUND(AVG(rating), 1) AS avg_rating
FROM reviews
GROUP BY product_id;

-- 案例4：分页页码计算
SELECT 
    CEIL(COUNT(*) / 10.0) AS total_pages 
FROM articles;
```

---

## 三、日期时间函数

### 3.1 常用日期函数

| 函数 | 说明 | 示例 |
|------|------|------|
| `NOW()` | 当前日期时间 | `NOW()` → '2024-01-01 12:30:45' |
| `CURDATE()` | 当前日期 | `CURDATE()` → '2024-01-01' |
| `CURTIME()` | 当前时间 | `CURTIME()` → '12:30:45' |
| `YEAR(date)` | 提取年份 | `YEAR(NOW())` → 2024 |
| `MONTH(date)` | 提取月份 | `MONTH(NOW())` → 1 |
| `DAY(date)` | 提取日 | `DAY(NOW())` → 1 |
| `HOUR(time)` | 提取小时 | `HOUR(NOW())` → 12 |
| `MINUTE(time)` | 提取分钟 | `MINUTE(NOW())` → 30 |
| `SECOND(time)` | 提取秒 | `SECOND(NOW())` → 45 |
| `DATE_ADD(date,INTERVAL n type)` | 日期加法 | `DATE_ADD(NOW(), INTERVAL 1 DAY)` |
| `DATE_SUB(date,INTERVAL n type)` | 日期减法 | `DATE_SUB(NOW(), INTERVAL 1 MONTH)` |
| `DATEDIFF(date1,date2)` | 日期差（天） | `DATEDIFF('2024-01-10','2024-01-01')` → 9 |
| `DATE_FORMAT(date,format)` | 格式化日期 | `DATE_FORMAT(NOW(),'%Y-%m-%d')` |

### 3.2 函数演示

**A. CURDATE：当前日期**

```sql
-- 返回当前日期（不包含时间）
SELECT CURDATE();  
-- 结果：'2024-01-01'
```

**B. CURTIME：当前时间**

```sql
-- 返回当前时间（不包含日期）
SELECT CURTIME();  
-- 结果：'12:30:45'
```

**C. NOW：当前日期和时间**

```sql
-- 返回当前日期和时间
SELECT NOW();  
-- 结果：'2024-01-01 12:30:45'
```

**D. YEAR、MONTH、DAY：提取年、月、日**

```sql
-- 提取日期的各个部分
SELECT YEAR(NOW());   -- 结果：2024
SELECT MONTH(NOW());  -- 结果：1
SELECT DAY(NOW());    -- 结果：1
```

**E. DATE_ADD：增加指定的时间间隔**

```sql
-- 日期加法：在当前日期基础上增加时间间隔
SELECT DATE_ADD(NOW(), INTERVAL 70 YEAR);  
-- 结果：'2094-01-01 12:30:45'

-- 常用的时间间隔
SELECT DATE_ADD(NOW(), INTERVAL 1 DAY);     -- 明天
SELECT DATE_ADD(NOW(), INTERVAL 1 WEEK);    -- 一周后
SELECT DATE_ADD(NOW(), INTERVAL 1 MONTH);   -- 一个月后
SELECT DATE_ADD(NOW(), INTERVAL 1 YEAR);    -- 一年后
```

**F. DATEDIFF：获取两个日期相差的天数**

```sql
-- 计算两个日期之间的天数差（date1 - date2）
SELECT DATEDIFF('2021-10-01', '2021-12-01');  
-- 结果：-61（负数表示第一个日期早于第二个日期）

-- 正确的用法（前面的日期应该晚于后面的日期，得到正数）
SELECT DATEDIFF('2021-12-01', '2021-10-01');  
-- 结果：61
```

### 3.3 示例演示

```sql
-- 1. 获取当前时间
SELECT NOW();       -- 2024-01-01 12:30:45
SELECT CURDATE();   -- 2024-01-01
SELECT CURTIME();   -- 12:30:45

-- 2. 提取日期部分
SELECT 
    YEAR(NOW()) AS year,
    MONTH(NOW()) AS month,
    DAY(NOW()) AS day,
    HOUR(NOW()) AS hour;

-- 3. 日期加减
SELECT DATE_ADD(NOW(), INTERVAL 1 DAY);     -- 明天
SELECT DATE_ADD(NOW(), INTERVAL 1 WEEK);    -- 一周后
SELECT DATE_ADD(NOW(), INTERVAL 1 MONTH);   -- 一个月后
SELECT DATE_ADD(NOW(), INTERVAL 1 YEAR);    -- 一年后
SELECT DATE_SUB(NOW(), INTERVAL 1 DAY);     -- 昨天

-- 4. 日期差值
SELECT DATEDIFF('2024-12-31', '2024-01-01') AS days;  -- 365

-- 5. 日期格式化
SELECT DATE_FORMAT(NOW(), '%Y-%m-%d');              -- 2024-01-01
SELECT DATE_FORMAT(NOW(), '%Y年%m月%d日');          -- 2024年01月01日
SELECT DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s');    -- 2024-01-01 12:30:45
SELECT DATE_FORMAT(NOW(), '%W, %M %d, %Y');        -- Monday, January 01, 2024
```

### 3.4 应用案例：查询员工入职天数

**业务需求**：查询所有员工的入职天数，并根据入职天数倒序排序。

**思路**：入职天数 = 当前日期 - 入职日期，所以需要使用 `DATEDIFF()` 函数来完成。

```sql
-- 查询员工入职天数，按入职天数倒序排序
SELECT 
    name, 
    entrydate,
    DATEDIFF(CURDATE(), entrydate) AS entrydays 
FROM emp 
ORDER BY entrydays DESC;
```

**结果说明：**
- `DATEDIFF(CURDATE(), entrydate)`：计算当前日期和入职日期的差值（天数）
- `entrydays`：入职天数（别名）
- `ORDER BY entrydays DESC`：按入职天数降序排列（入职时间越早，天数越大）

### 3.5 日期格式化符号

| 符号 | 说明 | 示例 |
|------|------|------|
| `%Y` | 四位年份 | 2024 |
| `%y` | 两位年份 | 24 |
| `%m` | 月份(01-12) | 01 |
| `%d` | 日(01-31) | 01 |
| `%H` | 小时(00-23) | 13 |
| `%i` | 分钟(00-59) | 30 |
| `%s` | 秒(00-59) | 45 |
| `%W` | 星期名 | Monday |
| `%M` | 月份名 | January |

### 3.6 实际应用案例

```sql
-- 案例1：查询今天注册的用户
SELECT * FROM users 
WHERE DATE(created_at) = CURDATE();

-- 案例2：查询本月订单
SELECT * FROM orders 
WHERE YEAR(order_date) = YEAR(NOW()) 
  AND MONTH(order_date) = MONTH(NOW());

-- 案例3：计算年龄
SELECT 
    name,
    birth_date,
    YEAR(CURDATE()) - YEAR(birth_date) AS age
FROM employees;

-- 案例4：查询最近7天的数据
SELECT * FROM articles 
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY);

-- 案例5：计算会员剩余天数
SELECT 
    username,
    expire_date,
    DATEDIFF(expire_date, CURDATE()) AS remaining_days
FROM members
WHERE expire_date > CURDATE();

-- 案例6：生成报表（按月统计）
SELECT 
    DATE_FORMAT(order_date, '%Y-%m') AS month,
    COUNT(*) AS order_count,
    SUM(amount) AS total_amount
FROM orders
GROUP BY month
ORDER BY month;
```

---

## 四、流程控制函数

### 4.1 流程函数概述

流程函数可以在SQL语句中实现条件筛选，从而提高语句的效率。常用的流程函数包括：

| 函数 | 功能 |
|------|------|
| `IF(value, t, f)` | 如果value为true，则返回t，否则返回f |
| `IFNULL(value1, value2)` | 如果value1不为空，返回value1，否则返回value2 |
| `CASE WHEN [val1] THEN [res1] ... ELSE [default] END` | 如果val1为true，返回res1，... 否则返回default默认值 |
| `CASE [expr] WHEN [val1] THEN [res1] ... ELSE [default] END` | 如果expr的值等于val1，返回res1，... 否则返回default默认值 |

### 4.2 IF函数

**语法**：`IF(condition, value_if_true, value_if_false)`

**函数演示：**

```sql
-- 基本用法：如果条件为真返回第一个值，否则返回第二个值
SELECT IF(false, 'Ok', 'Error');  
-- 结果：'Error'
```

**示例：**

```sql
-- 示例1：判断及格
SELECT 
    name,
    score,
    IF(score >= 60, '及格', '不及格') AS result
FROM students;

-- 示例2：判断性别
SELECT 
    name,
    IF(gender = 1, '男', '女') AS gender_text
FROM users;

-- 示例3：判断是否在职
SELECT 
    name,
    IF(status = 1, '在职', '离职') AS work_status
FROM employees;
```

### 4.3 IFNULL函数

**语法**：`IFNULL(value1, value2)`

**函数演示：**

```sql
-- 如果value1不为空，返回value1，否则返回value2
SELECT IFNULL('Ok', 'Default');   -- 结果：'Ok'
SELECT IFNULL('', 'Default');     -- 结果：''（空字符串不为NULL）
SELECT IFNULL(null, 'Default');   -- 结果：'Default'
```

**示例：**

```sql
-- 示例1：处理NULL值
SELECT 
    name,
    IFNULL(phone, '未填写') AS phone
FROM users;

-- 示例2：计算总价（含运费）
SELECT 
    order_id,
    price + IFNULL(shipping_fee, 0) AS total
FROM orders;

-- 示例3：显示默认头像
SELECT 
    username,
    IFNULL(avatar, 'default.jpg') AS avatar
FROM users;
```

### 4.4 CASE表达式

**CASE表达式**：实现多条件判断，比IF函数更灵活。

#### 4.4.1 语法

**语法一：简单CASE（等值判断）**

```sql
CASE expression
    WHEN value1 THEN result1
    WHEN value2 THEN result2
    ...
    ELSE default_result
END
```

**语法二：搜索CASE（条件判断）**

```sql
CASE
    WHEN condition1 THEN result1
    WHEN condition2 THEN result2
    ...
    ELSE default_result
END
```

**函数演示：**

```sql
-- 简单CASE：根据表达式的值进行等值匹配
CASE workaddress
    WHEN '北京' THEN '一线城市'
    WHEN '上海' THEN '一线城市'
    ELSE '二线城市'
END

-- 搜索CASE：根据条件进行判断
CASE
    WHEN score >= 90 THEN '优秀'
    WHEN score >= 80 THEN '良好'
    WHEN score >= 60 THEN '及格'
    ELSE '不及格'
END
```

#### 4.4.2 应用案例：工作地址分类

**业务需求**：查询emp表的员工姓名和工作地址，将北京/上海归类为一线城市，其他归类为二线城市。

**SQL语句：**

```sql
SELECT
    name,
    workaddress,
    (CASE workaddress 
        WHEN '北京' THEN '一线城市' 
        WHEN '上海' THEN '一线城市' 
        ELSE '二线城市' 
    END) AS '工作地址'
FROM emp;
```

**结果示例：**

| name | workaddress | 工作地址 |
|------|-------------|----------|
| 张三 | 北京 | 一线城市 |
| 李四 | 上海 | 一线城市 |
| 王五 | 广州 | 二线城市 |
| 赵六 | 深圳 | 二线城市 |

**说明：**
- 使用简单CASE表达式，根据 `workaddress` 字段的值进行等值匹配
- 当值为'北京'或'上海'时，返回'一线城市'
- 其他情况返回'二线城市'

### 4.5 CASE表达式完整示例

**语法一：简单CASE**
```sql
CASE expression
    WHEN value1 THEN result1
    WHEN value2 THEN result2
    ...
    ELSE default_result
END
```

**语法二：搜索CASE**
```sql
CASE
    WHEN condition1 THEN result1
    WHEN condition2 THEN result2
    ...
    ELSE default_result
END
```

**示例：**

```sql
-- 示例1：等级评定（搜索CASE）
SELECT 
    name,
    score,
    CASE
        WHEN score >= 90 THEN '优秀'
        WHEN score >= 80 THEN '良好'
        WHEN score >= 60 THEN '及格'
        ELSE '不及格'
    END AS grade
FROM students;

-- 示例2：工作地址分类（简单CASE）
SELECT 
    name,
    work_city,
    CASE work_city
        WHEN '北京' THEN '一线城市'
        WHEN '上海' THEN '一线城市'
        WHEN '广州' THEN '一线城市'
        WHEN '深圳' THEN '一线城市'
        ELSE '其他城市'
    END AS city_level
FROM employees;

-- 示例3：季度划分（搜索CASE）
SELECT 
    order_date,
    CASE
        WHEN MONTH(order_date) BETWEEN 1 AND 3 THEN 'Q1'
        WHEN MONTH(order_date) BETWEEN 4 AND 6 THEN 'Q2'
        WHEN MONTH(order_date) BETWEEN 7 AND 9 THEN 'Q3'
        ELSE 'Q4'
    END AS quarter
FROM orders;

-- 示例4：薪资调整（在UPDATE中使用CASE）
UPDATE employees
SET salary = CASE
    WHEN department = '技术部' THEN salary * 1.2
    WHEN department = '销售部' THEN salary * 1.15
    WHEN department = '市场部' THEN salary * 1.1
    ELSE salary * 1.05
END;
```

### 4.6 综合案例：学员成绩表

**创建成绩表：**

```sql
-- 创建学员成绩表
CREATE TABLE score(
    id int COMMENT 'ID',
    name varchar(20) COMMENT '姓名',
    math int COMMENT '数学',
    english int COMMENT '英语',
    chinese int COMMENT '语文'
) COMMENT '学员成绩表';

-- 插入测试数据
INSERT INTO score(id, name, math, english, chinese) VALUES 
(1, 'Tom', 67, 88, 95), 
(2, 'Rose', 23, 66, 90),
(3, 'Jack', 56, 98, 76);
```

**业务需求1：计算每个学员的总分和平均分**

```sql
SELECT 
    name,
    math,
    english,
    chinese,
    (math + english + chinese) AS total_score,
    ROUND((math + english + chinese) / 3, 1) AS avg_score
FROM score;
```

**业务需求2：根据总分判定等级**

```sql
SELECT 
    name,
    (math + english + chinese) AS total_score,
    CASE
        WHEN (math + english + chinese) >= 270 THEN '优秀'
        WHEN (math + english + chinese) >= 240 THEN '良好'
        WHEN (math + english + chinese) >= 180 THEN '及格'
        ELSE '不及格'
    END AS grade
FROM score;
```

**业务需求3：判定每科是否及格**

```sql
SELECT 
    name,
    math,
    IF(math >= 60, '及格', '不及格') AS math_result,
    english,
    IF(english >= 60, '及格', '不及格') AS english_result,
    chinese,
    IF(chinese >= 60, '及格', '不及格') AS chinese_result
FROM score;
```

---

## 五、聚合函数

### 5.1 常用聚合函数

| 函数 | 说明 |
|------|------|
| `COUNT(*)` | 统计行数 |
| `COUNT(column)` | 统计非NULL值数量 |
| `SUM(column)` | 求和 |
| `AVG(column)` | 平均值 |
| `MAX(column)` | 最大值 |
| `MIN(column)` | 最小值 |
| `GROUP_CONCAT(column)` | 字符串聚合 |

### 5.2 示例演示

```sql
-- 统计订单总数
SELECT COUNT(*) AS total_orders FROM orders;

-- 计算总销售额
SELECT SUM(amount) AS total_sales FROM orders;

-- 计算平均分
SELECT AVG(score) AS avg_score FROM students;

-- 查找最高和最低价格
SELECT MAX(price) AS max_price, MIN(price) AS min_price FROM products;

-- 字符串聚合（拼接）
SELECT 
    department,
    GROUP_CONCAT(name SEPARATOR ', ') AS employees
FROM employees
GROUP BY department;
```

---

## 六、综合应用案例

### 案例1：用户信息格式化

```sql
SELECT 
    CONCAT(UPPER(SUBSTRING(name, 1, 1)), LOWER(SUBSTRING(name, 2))) AS formatted_name,
    CONCAT(
        SUBSTRING(phone, 1, 3),
        '-',
        SUBSTRING(phone, 4, 4),
        '-',
        SUBSTRING(phone, 8)
    ) AS formatted_phone,
    CONCAT(YEAR(CURDATE()) - YEAR(birth_date), '岁') AS age,
    IF(gender = 1, '男', '女') AS gender_text
FROM users;
```

### 案例2：订单数据分析

```sql
SELECT 
    DATE_FORMAT(order_date, '%Y-%m') AS month,
    COUNT(*) AS order_count,
    ROUND(SUM(amount), 2) AS total_amount,
    ROUND(AVG(amount), 2) AS avg_amount,
    MAX(amount) AS max_amount,
    MIN(amount) AS min_amount
FROM orders
WHERE order_date >= DATE_SUB(NOW(), INTERVAL 6 MONTH)
GROUP BY month
ORDER BY month;
```

### 案例3：商品推荐标签

```sql
SELECT 
    product_name,
    price,
    CASE
        WHEN price < 100 THEN '经济实惠'
        WHEN price BETWEEN 100 AND 500 THEN '性价比之选'
        WHEN price BETWEEN 500 AND 1000 THEN '品质之选'
        ELSE '高端精品'
    END AS price_tag,
    CONCAT(ROUND(sales_count / 1000, 1), 'K+') AS sales_text,
    IF(stock > 100, '现货充足', '库存紧张') AS stock_status
FROM products;
```

---

## 七、函数应用场景总结

### 场景回顾

**场景1：计算入职天数**

数据库中，存储的是入职日期，如 2000-01-01，如何快速计算出入职天数呢？

**答案：** 使用 `DATEDIFF()` 函数

```sql
-- 计算入职天数
SELECT name, DATEDIFF(CURDATE(), entrydate) AS entrydays FROM emp;
```

**场景2：分数等级判定**

数据库中，存储的是学生的分数值，如98、75，如何快速判定分数的等级呢？

**答案：** 使用 `CASE ... WHEN ...` 表达式

```sql
-- 判定分数等级
SELECT 
    name,
    score,
    CASE
        WHEN score >= 90 THEN '优秀'
        WHEN score >= 80 THEN '良好'
        WHEN score >= 60 THEN '及格'
        ELSE '不及格'
    END AS grade
FROM students;
```

## 八、本章总结

### 核心要点

1. **字符串函数**：拼接、截取、替换、格式化
2. **数值函数**：取整、四舍五入、随机数
3. **日期函数**：获取、计算、格式化日期
4. **流程函数**：IF、CASE条件判断

### 学习建议

1. ✅ 熟记常用函数的语法和用途
2. ✅ 多练习组合使用多个函数
3. ✅ 关注实际业务场景的应用
4. ✅ 注意NULL值的处理
5. ✅ 灵活运用流程函数实现业务逻辑

---

## 练习题

```sql
-- 1. 将所有用户名转为大写
SELECT UPPER(username) FROM users;

-- 2. 查询姓"张"的用户（使用SUBSTRING）
SELECT * FROM users WHERE SUBSTRING(name, 1, 1) = '张';

-- 3. 计算所有商品的平均价格，保留2位小数
SELECT ROUND(AVG(price), 2) AS avg_price FROM products;

-- 4. 查询注册超过1年的用户
SELECT * FROM users 
WHERE DATEDIFF(NOW(), created_at) > 365;

-- 5. 根据年龄分组（少年、青年、中年、老年）
SELECT 
    name,
    CASE
        WHEN age < 18 THEN '少年'
        WHEN age < 35 THEN '青年'
        WHEN age < 60 THEN '中年'
        ELSE '老年'
    END AS age_group
FROM users;
```

---

**上一章：** [SQL基础语法](/tutorials/java-backend/mysql/第01章-基础篇/03-SQL基础语法/)

**下一章：** [约束与数据完整性](/tutorials/java-backend/mysql/第02章-进阶篇/02-约束与数据完整性/) →
