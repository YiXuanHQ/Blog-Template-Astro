---
title: 存储过程和存储函数
prevChapter: "java-backend/mysql/第04章-实践篇/04-数据完整性"
nextChapter: "java-backend/mysql/第04章-实践篇/06-数据库的安全管理"
parentChapter: "java-backend/mysql/README"
---
# 存储过程和存储函数

> 本章通过实际案例学习MySQL存储过程和存储函数的创建、调用和管理。存储过程和函数可以封装复杂的业务逻辑，提高代码复用性和执行效率。

## ⚡ 快速参考

- **存储过程**：CREATE PROCEDURE、CALL、DROP PROCEDURE
- **存储函数**：CREATE FUNCTION、SELECT function_name()、DROP FUNCTION
- **参数类型**：IN（输入）、OUT（输出）、INOUT（输入输出）
- **流程控制**：IF、CASE、WHILE、LOOP、REPEAT
- **游标**：DECLARE CURSOR、OPEN、FETCH、CLOSE
- **优势**：预编译、减少网络传输、代码复用、业务逻辑封装

## 📚 学习目标

1. 掌握存储过程的创建、调用和删除方法
2. 理解存储过程参数类型（IN、OUT、INOUT）的使用
3. 掌握存储函数的创建和调用
4. 理解存储过程中的流程控制语句
5. 掌握游标的使用方法
6. 理解存储过程和函数在实际业务中的应用
7. 能够根据业务需求设计和实现存储过程和函数

## 实践目标

通过本实践，你将学会：
- ✅ 创建和调用存储过程
- ✅ 存储过程的参数使用（IN、OUT、INOUT）
- ✅ 创建和调用存储函数
- ✅ 存储过程中的游标使用
- ✅ 删除存储过程和函数

## 实践环境

**数据库：** studentsdb

**数据表：**
- `student_info`：学生信息表
- `curriculum`：课程表
- `grade`：成绩表

## 实践步骤

### 一、存储过程

#### 1. 创建带输入参数的存储过程

创建存储过程 `stu_info`，执行时通过输入姓名，可以查询该姓名的学生的各科成绩。

```sql
USE studentsdb;

DELIMITER @@
CREATE PROCEDURE stu_info(IN name CHAR(8))
BEGIN
    SELECT s.学号, 姓名, 课程编号, 分数 
    FROM student_info s, grade g
    WHERE s.学号 = g.学号 AND 姓名 = name;
END @@
DELIMITER ;

-- 使用CALL命令执行存储过程stu_info，参数值为'张青平'
CALL stu_info('张青平');
```

#### 2. 创建无参数的存储过程

使用 `studentsdb` 数据库中的 `student_info` 表、`curriculum` 表、`grade` 表。创建一个存储过程 `stu_grade`，查询学号为 `0001` 的学生的姓名、课程名称、分数。

```sql
DELIMITER @@
CREATE PROCEDURE stu_grade()
BEGIN
    SELECT 姓名, 课程名称, 分数 
    FROM student_info s, curriculum c, grade g
    WHERE s.学号 = g.学号 
      AND c.课程编号 = g.课程编号 
      AND s.学号 = '0001';
END @@
DELIMITER ;

-- 调用存储过程
CALL stu_grade();
```

#### 3. 创建带聚合函数的存储过程

使用 `studentsdb` 数据库中的 `student_info` 表、`curriculum` 表、`grade` 表。创建存储过程 `stu_name`，当任意输入一个学生的姓名时，查看其课程的最高分、最低分、平均分。

```sql
DELIMITER @@
CREATE PROCEDURE stu_name(IN name CHAR(8))
BEGIN
    SELECT 姓名, 
           MAX(g.分数) AS 最高分,
           MIN(g.分数) AS 最低分,
           AVG(g.分数) AS 平均分 
    FROM student_info s, curriculum c, grade g
    WHERE s.学号 = g.学号 
      AND c.课程编号 = g.课程编号 
      AND 姓名 = name 
    GROUP BY 姓名;
END @@
DELIMITER ;

-- 调用存储过程
CALL stu_name('张青平');

-- 删除存储过程
DROP PROCEDURE stu_name;
```

#### 4. 创建带输出参数的存储过程

使用 `studentsdb` 数据库中的 `grade` 表。创建一个存储过程 `stu_g_r`，当输入一个学生的学号时，通过返回输出参数获取该学生选修课程的门数。

```sql
DELIMITER @@
CREATE PROCEDURE stu_g_r(IN cno CHAR(4), OUT num INT)
BEGIN
    SELECT COUNT(*) INTO num 
    FROM grade 
    WHERE 学号 = cno;
END @@
DELIMITER ;

-- 执行存储过程stu_g_r，输入学号0002
CALL stu_g_r('0002', @num);

-- 显示0002号学生的选课门数
SELECT @num AS 选课门数;
```

### 二、存储函数

#### 5. 创建简单的存储函数

使用 `studentsdb` 数据库中的 `curriculum` 表、`grade` 表。创建一个存储函数 `num_func`，统计指定课程名称的选课人数。

**注意：** MySQL创建函数需要设置 `log_bin_trust_function_creators` 参数。

```sql
-- 设置允许创建函数（MySQL 8.0+）
SET GLOBAL log_bin_trust_function_creators = 1;

DELIMITER @@
CREATE FUNCTION num_func(cname VARCHAR(50))
RETURNS INT
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE num INT;
    SELECT COUNT(*) INTO num 
    FROM grade g, curriculum c
    WHERE g.课程编号 = c.课程编号 
      AND c.课程名称 = cname;
    RETURN num;
END @@
DELIMITER ;

-- 执行存储函数num_func，查看"C语言程序设计"选课人数
SELECT num_func('C语言程序设计') AS 选课人数;
```

#### 6. 创建使用游标的存储函数

使用 `studentsdb` 数据库中的 `curriculum` 表、`grade` 表。创建一个存储函数 `avg_func`，通过游标统计指定课程的平均分。

```sql
DELIMITER @@
CREATE FUNCTION avg_func(cname VARCHAR(50))
RETURNS DECIMAL(5,2)
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE v_avg DECIMAL(5,2);
    DECLARE avg_cur CURSOR FOR 
        SELECT AVG(分数) 
        FROM grade g, curriculum c
        WHERE g.课程编号 = c.课程编号 
          AND 课程名称 = cname;
    
    OPEN avg_cur;
    FETCH avg_cur INTO v_avg;
    CLOSE avg_cur;
    
    RETURN v_avg;
END @@
DELIMITER ;

-- 执行存储函数avg_func，查看"C语言程序设计"课程平均分
SELECT avg_func('C语言程序设计') AS 课程平均分;

-- 删除存储函数
DROP FUNCTION avg_func;
```

## 实践总结

### 关键知识点

#### 存储过程 vs 存储函数

| 特性 | 存储过程 | 存储函数 |
|------|---------|---------|
| **返回值** | 可以有多个OUT参数 | 只能返回一个值 |
| **调用方式** | `CALL 过程名()` | `SELECT 函数名()` |
| **使用场景** | 执行操作、批量处理 | 计算、返回单个值 |
| **事务处理** | 可以包含事务 | 不能包含事务 |

#### 参数类型

1. **IN参数**
   - 输入参数
   - 调用时传入值
   - 过程内部不能修改

2. **OUT参数**
   - 输出参数
   - 过程内部赋值
   - 调用后可以获取值

3. **INOUT参数**
   - 输入输出参数
   - 既可以传入也可以传出

#### 游标使用

游标用于逐行处理结果集：

```sql
DECLARE cursor_name CURSOR FOR SELECT ...;
OPEN cursor_name;
FETCH cursor_name INTO variables;
CLOSE cursor_name;
```

### 注意事项

- ⚠️ 存储函数必须指定 `DETERMINISTIC` 或 `NOT DETERMINISTIC`
- ⚠️ 存储函数必须指定 `READS SQL DATA`、`MODIFIES SQL DATA` 等特性
- ⚠️ 创建函数需要 `log_bin_trust_function_creators = 1`
- ⚠️ 使用 `DELIMITER` 改变语句结束符
- ✅ 存储过程可以提高执行效率
- ✅ 存储函数可以在SQL语句中使用
- ✅ 游标用于逐行处理大量数据

### 最佳实践

1. **命名规范**
   - 使用有意义的名称
   - 统一命名风格
   - 避免与关键字冲突

2. **错误处理**
   - 使用异常处理机制
   - 返回错误信息
   - 记录错误日志

3. **性能优化**
   - 避免在循环中执行SQL
   - 合理使用索引
   - 优化查询语句

---

## 练习题

1. 创建一个存储过程，根据学号查询学生的所有课程成绩
2. 创建一个存储函数，计算指定学生的平均分
3. 创建一个存储过程，使用游标遍历所有学生并输出信息
4. 创建一个带INOUT参数的存储过程，实现计数器功能

---

**上一章：** [数据完整性](/tutorials/java-backend/mysql/第04章-实践篇/04-数据完整性/)

**下一章：** [数据库的安全管理](/tutorials/java-backend/mysql/第04章-实践篇/06-数据库的安全管理/) →
