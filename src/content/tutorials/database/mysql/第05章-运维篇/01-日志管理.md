---
title: 日志管理
nextChapter: "java-backend/mysql/第05章-运维篇/02-主从复制"
parentChapter: "java-backend/mysql/README"
---
# 日志管理

> MySQL提供了多种日志来记录数据库的运行状态、操作记录和错误信息。本章学习MySQL的各种日志类型及配置方法。

## ⚡ 快速参考

- **错误日志**：记录MySQL启动、停止和运行错误，默认开启，位置可通过log_error配置
- **二进制日志（binlog）**：记录所有DDL和DML操作，用于主从复制和数据恢复
- **查询日志**：记录所有查询操作，包括SELECT和SHOW，默认关闭
- **慢查询日志**：记录执行时间超过阈值的SQL语句，用于性能优化
- **日志配置**：通过my.cnf配置文件或SET GLOBAL命令设置
- **日志查看**：mysqlbinlog查看binlog、tail查看文本日志、SHOW VARIABLES查看配置

## 📚 学习目标

1. 理解MySQL各种日志的作用和用途
2. 掌握错误日志的配置和查看方法
3. 掌握二进制日志的配置、查看和使用
4. 理解查询日志和慢查询日志的配置方法
5. 掌握使用mysqlbinlog工具查看二进制日志
6. 理解日志在数据库运维和故障排查中的重要性
7. 能够根据业务需求合理配置各种日志
8. 掌握日志文件的清理和维护方法

## 一、错误日志

### 1.1 错误日志概述

错误日志是 MySQL 中最重要的日志之一，它记录了当 mysqld 启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。当数据库出现任何故障导致无法正常使用时，建议首先查看此日志。

该日志是默认开启的，默认存放目录 `/var/log/`，默认的日志文件名为 `mysqld.log`。

**查看日志位置：**
```sql
show variables like '%log_error%';
```

![image-20260112202343598](https://raw.gitcode.com/YiXuanHQ/YiXuan-Blog-Image/raw/main/tutorials/java-backend/mysql/image-20260112202343598.png)

**示例输出：**

```
+------------------+-------------------------+
| Variable_name    | Value                   |
+------------------+-------------------------+
| log_error        | /var/log/mysqld.log     |
| log_error_verbosity | 3                    |
+------------------+-------------------------+
```

**日志级别：**

- `1`：只记录错误信息
- `2`：记录错误和警告信息
- `3`：记录错误、警告和通知信息（默认）

**配置方法：**
```ini
# /etc/my.cnf
[mysqld]
log_error = /var/log/mysql/error.log
log_error_verbosity = 3
```

## 二、二进制日志

### 2.1 二进制日志概述

二进制日志（BINLOG）记录了所有的 DDL（数据定义语言）语句和 DML（数据操纵语言）语句，但不包括数据查询（SELECT、SHOW）语句。

**作用：**
1. 灾难时的数据恢复
2. MySQL的主从复制

在MySQL8版本中，默认二进制日志是开启着的。

**查看二进制日志相关参数：**
```sql
show variables like '%log_bin%';
```

![image-20260112202401208](https://raw.gitcode.com/YiXuanHQ/YiXuan-Blog-Image/raw/main/tutorials/java-backend/mysql/image-20260112202401208.png)

![image-20260112202419436](https://raw.gitcode.com/YiXuanHQ/YiXuan-Blog-Image/raw/main/tutorials/java-backend/mysql/image-20260112202419436.png)

**主要参数说明：**

- `log_bin`：是否开启二进制日志
- `log_bin_basename`：当前数据库服务器的binlog日志的基础名称(前缀)，具体的binlog文件名需要再该basename的基础上加上编号(编号从000001开始)
- `log_bin_index`：binlog的索引文件，里面记录了当前服务器关联的binlog文件有哪些

### 2.2 二进制日志格式

MySQL服务器中提供了多种格式来记录二进制日志，具体格式及特点如下：

| 日志格式 | 含义 |
|---------|------|
| **STATEMENT** | 基于SQL语句的日志记录，记录的是SQL语句，对数据进行修改的SQL都会记录在日志文件中 |
| **ROW** | 基于行的日志记录，记录的是每一行的数据变更（默认） |
| **MIXED** | 混合了STATEMENT和ROW两种格式，默认采用STATEMENT，在某些特殊情况下会自动切换为ROW进行记录 |

**查看当前日志格式：**
```sql
show variables like '%binlog_format%';
```

![image-20260112202439478](https://raw.gitcode.com/YiXuanHQ/YiXuan-Blog-Image/raw/main/tutorials/java-backend/mysql/image-20260112202439478.png)

**配置方法：**
如果需要配置二进制日志的格式，只需要在 `/etc/my.cnf` 中配置 `binlog_format` 参数即可。

```ini
# /etc/my.cnf
[mysqld]
binlog_format = ROW  # 可选值：STATEMENT、ROW、MIXED
```

### 2.3 查看二进制日志

由于日志是以二进制方式存储的，不能直接读取，需要通过二进制日志查询工具 `mysqlbinlog` 来查看。

**语法：**
```bash
mysqlbinlog [参数选项] log-files1 log-files2 ...
```

**参数选项：**
- `-d, --database=name` 指定数据库名称，只列出指定的数据库相关操作
- `-o, --offset=#` 忽略掉日志中的前n行命令
- `-r, --result-file=name` 将输出的文本格式日志输出到指定文件
- `-s, --short-form` 显示简单格式，省略掉一些信息
- `--start-datetime=date1 --stop-datetime=date2` 指定日期间隔内的所有日志
- `--start-position=pos1 --stop-position=pos2` 指定位置间隔内的所有日志
- `-v` 将行事件(数据变更)重构为SQL语句
- `-vv` 将行事件(数据变更)重构为SQL语句，并输出注释信息

**示例：**

**A. 查看二进制日志文件**
```bash
# 查看二进制日志文件内容
mysqlbinlog /var/lib/mysql/binlog.000008

# 显示简单格式（省略详细信息）
mysqlbinlog -s /var/lib/mysql/binlog.000008
```

**B. 指定数据库**
```bash
# 只查看指定数据库的操作
mysqlbinlog -d db01 /var/lib/mysql/binlog.000008
```

**C. 指定时间范围**
```bash
# 查看指定时间范围内的日志
mysqlbinlog --start-datetime="2023-01-01 00:00:00" \
            --stop-datetime="2023-01-02 00:00:00" \
            /var/lib/mysql/binlog.000008
```

**D. 指定位置范围**
```bash
# 查看指定位置范围内的日志
mysqlbinlog --start-position=100 \
            --stop-position=200 \
            /var/lib/mysql/binlog.000008
```

**E. 重构为SQL语句**
```bash
# 将行事件重构为SQL语句
mysqlbinlog -v /var/lib/mysql/binlog.000008

# 输出注释信息
mysqlbinlog -vv /var/lib/mysql/binlog.000008
```

### 2.4 删除二进制日志

对于比较繁忙的业务系统，每天生成的binlog数据巨大，如果长时间不清除，将会占用大量磁盘空间。可以通过以下几种方式清理日志：

| 指令 | 含义 |
|------|------|
| `reset master` | 删除全部 binlog 日志，删除之后，日志编号将从 binlog.000001重新开始 |
| `purge master logs to 'binlog.*'` | 删除 * 编号之前的所有日志 |
| `purge master logs before 'yyyy-mm-dd hh24:mi:ss'` | 删除日志为 "yyyy-mm-dd hh24:mi:ss" 之前产生的所有日志 |

**示例：**
```sql
-- 删除编号为000005之前的所有日志
PURGE MASTER LOGS TO 'binlog.000005';

-- 删除2023-01-01之前的所有日志
PURGE MASTER LOGS BEFORE '2023-01-01 00:00:00';

-- 删除全部日志（谨慎使用）
RESET MASTER;
```

**自动删除配置：**

也可以在mysql的配置文件中配置二进制日志的过期时间，设置了之后，二进制日志过期会自动删除。

**查看过期时间配置：**
```sql
show variables like '%binlog_expire_logs_seconds%';
```

**配置方法：**
```ini
# /etc/my.cnf
[mysqld]
# 设置binlog过期时间为7天（单位：秒）
binlog_expire_logs_seconds = 604800
```

## 三、查询日志

### 3.1 查询日志概述

查询日志中记录了客户端的所有操作语句，而二进制日志不包含查询数据的SQL语句。默认情况下，查询日志是未开启的。

![image-20260112202627714](https://raw.gitcode.com/YiXuanHQ/YiXuan-Blog-Image/raw/main/tutorials/java-backend/mysql/image-20260112202627714.png)

### 3.2 开启查询日志

如果需要开启查询日志，可以修改MySQL的配置文件 `/etc/my.cnf` 文件，添加如下内容：

```ini
# /etc/my.cnf
[mysqld]
# 该选项用来开启查询日志，可选值：0 或者 1；0 代表关闭，1 代表开启
general_log=1
# 设置日志的文件名，如果没有指定，默认的文件名为 host_name.log
general_log_file=mysql_query.log
```

开启了查询日志之后，在MySQL的数据存放目录，也就是 `/var/lib/mysql/` 目录下就会出现 `mysql_query.log` 文件。之后所有的客户端的增删改查操作都会记录在该日志文件之中，长时间运行后，该日志文件将会非常大。

**注意事项：**
- ⚠️ 查询日志会记录所有SQL操作，包括SELECT查询，会产生大量日志
- ⚠️ 建议只在需要调试时才开启，生产环境一般不开启
- ⚠️ 如果开启，需要定期清理日志文件

**动态开启/关闭：**
```sql
-- 开启查询日志
SET GLOBAL general_log = 'ON';
SET GLOBAL general_log_file = '/var/lib/mysql/mysql_query.log';

-- 关闭查询日志
SET GLOBAL general_log = 'OFF';
```

## 四、慢查询日志

### 4.1 慢查询日志概述

慢查询日志记录了所有执行时间超过参数 `long_query_time` 设置值并且扫描记录数不小于 `min_examined_row_limit` 的所有的SQL语句的日志，默认未开启。`long_query_time` 默认为 10 秒，最小为 0，精度可以到微秒。

### 4.2 开启慢查询日志

如果需要开启慢查询日志，需要在MySQL的配置文件 `/etc/my.cnf` 中配置如下参数：

```ini
# /etc/my.cnf
[mysqld]
# 慢查询日志
slow_query_log=1
# 执行时间参数（单位：秒）
long_query_time=2
# 慢查询日志文件位置
slow_query_log_file=/var/lib/mysql/slow.log
```

### 4.3 慢查询日志高级配置

默认情况下，不会记录管理语句，也不会记录不使用索引进行查找的查询。可以使用 `log_slow_admin_statements` 和 `log_queries_not_using_indexes` 更改此行为，如下所述：

```ini
# /etc/my.cnf
[mysqld]
# 记录执行较慢的管理语句
log_slow_admin_statements = 1
# 记录执行较慢的未使用索引的语句
log_queries_not_using_indexes = 1
```

**完整配置示例：**
```ini
# /etc/my.cnf
[mysqld]
# 开启慢查询日志
slow_query_log = 1
# 慢查询阈值（单位：秒）
long_query_time = 2
# 慢查询日志文件
slow_query_log_file = /var/lib/mysql/slow.log
# 记录管理语句（如ALTER TABLE、ANALYZE TABLE等）
log_slow_admin_statements = 1
# 记录未使用索引的查询
log_queries_not_using_indexes = 1
# 最小扫描行数（超过此值的查询才会记录）
min_examined_row_limit = 100
```

**动态配置：**
```sql
-- 开启慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;
SET GLOBAL slow_query_log_file = '/var/lib/mysql/slow.log';

-- 查看慢查询日志状态
SHOW VARIABLES LIKE '%slow_query%';
SHOW VARIABLES LIKE '%long_query_time%';
```

**查看慢查询日志：**
```bash
# 查看慢查询日志内容
tail -f /var/lib/mysql/slow.log

# 使用mysqldumpslow工具分析慢查询日志（推荐）
mysqldumpslow /var/lib/mysql/slow.log
mysqldumpslow -s t -t 10 /var/lib/mysql/slow.log  # 按时间排序，取前10条
mysqldumpslow -s c -t 10 /var/lib/mysql/slow.log  # 按次数排序，取前10条
```

**注意事项：**
- ✅ 上述所有的参数配置完成之后，都需要重新启动MySQL服务器才可以生效
- ⚠️ 慢查询日志会占用一定磁盘空间，需要定期清理
- 📊 生产环境建议开启慢查询日志，有助于SQL优化

---

## 五、本章总结

### 日志类型对比

| 日志类型 | 默认状态 | 主要用途 | 建议 |
|---------|---------|---------|------|
| **错误日志** | 开启 | 记录启动、停止和错误信息 | ✅ 必须开启 |
| **二进制日志** | 开启（8.0） | 数据恢复、主从复制 | ✅ 生产环境必须开启 |
| **查询日志** | 关闭 | 记录所有SQL操作 | ⚠️ 调试时开启，生产环境不建议 |
| **慢查询日志** | 关闭 | 记录执行慢的SQL | ✅ 生产环境建议开启 |

### 最佳实践

1. ✅ **错误日志**：保持开启，定期查看
2. ✅ **二进制日志**：必须开启，配置过期时间自动清理
3. ⚠️ **查询日志**：生产环境关闭，调试时临时开启
4. ✅ **慢查询日志**：开启并定期分析，优化慢SQL
5. 📊 **日志轮转**：使用logrotate工具定期轮转日志文件
6. 💾 **日志备份**：重要日志定期备份

---

## 练习题

```sql
-- 1. 查看错误日志位置
SHOW VARIABLES LIKE '%log_error%';

-- 2. 查看二进制日志相关参数
SHOW VARIABLES LIKE '%log_bin%';
SHOW VARIABLES LIKE '%binlog_format%';

-- 3. 查看慢查询日志配置
SHOW VARIABLES LIKE '%slow_query%';
SHOW VARIABLES LIKE '%long_query_time%';

-- 4. 查看当前的二进制日志文件
SHOW BINARY LOGS;

-- 5. 查看二进制日志事件
SHOW BINLOG EVENTS IN 'binlog.000008' LIMIT 10;
```

---

**上一章：** [数据库的备份与恢复](/tutorials/java-backend/mysql/第04章-实践篇/07-数据库的备份与恢复/)

**下一章：** [主从复制](/tutorials/java-backend/mysql/第05章-运维篇/02-主从复制/) →
