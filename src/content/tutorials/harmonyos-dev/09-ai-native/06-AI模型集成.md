---
title: AI æ¨¡å‹é›†æˆ
date: 2025-01-22
prevChapter: "harmonyos-dev/09-ai-native/05-è‡ªç„¶è¯­è¨€å¤„ç†"
nextChapter: "harmonyos-dev/09-ai-native/07-AIåº”ç”¨å®æˆ˜"
parentChapter: "harmonyos-dev/09-ai-native/README"
---
# AI æ¨¡å‹é›†æˆ

> è‡ªå®šä¹‰ AI æ¨¡å‹éƒ¨ç½²

## ğŸ”„ æ¨¡å‹æ ¼å¼è½¬æ¢

### MindSpore æ¨¡å‹

```typescript
// MindSpore Lite æ¨¡å‹å¯ç›´æ¥ä½¿ç”¨
const model = await aiEngine.loadModel({
  modelPath: '/data/storage/el2/base/files/model.ms',
  modelType: 'MindSpore'
})
```

### ONNX æ¨¡å‹è½¬æ¢

```bash
# ä½¿ç”¨è½¬æ¢å·¥å…·
converter_lite --fmk=ONNX \
  --modelFile=model.onnx \
  --outputFile=model.ms \
  --optimize=general
```

### TensorFlow æ¨¡å‹è½¬æ¢

```bash
converter_lite --fmk=TFLITE \
  --modelFile=model.tflite \
  --outputFile=model.ms \
  --optimize=general
```

## ğŸ“¦ æ¨¡å‹éƒ¨ç½²

### æœ¬åœ°æ¨¡å‹åŠ è½½

```typescript
import { modelManager } from '@ohos.ai.model'

class LocalModelManager {
  private model: Model
  
  async loadModel(modelName: string) {
    const modelPath = `/data/storage/el2/base/files/${modelName}.ms`
    
    this.model = await modelManager.load({
      path: modelPath,
      enableNPU: true,
      precision: 'FP16'
    })
  }
  
  async predict(input: ArrayBuffer) {
    const output = await this.model.infer(input)
    return this.parseOutput(output)
  }
  
  private parseOutput(output: ArrayBuffer) {
    // è§£æè¾“å‡ºæ•°æ®
    return output
  }
}
```

### åŠ¨æ€æ¨¡å‹æ›´æ–°

```typescript
class ModelUpdater {
  async checkUpdate(): Promise<boolean> {
    const response = await http.request('https://api.example.com/model/version')
    const serverVersion = response.version
    const localVersion = await this.getLocalVersion()
    
    return serverVersion > localVersion
  }
  
  async downloadModel(url: string): Promise<string> {
    const savePath = '/data/storage/el2/base/files/new_model.ms'
    
    await http.downloadFile(url, savePath, {
      onProgress: (progress) => {
        console.log(`ä¸‹è½½è¿›åº¦: ${progress}%`)
      }
    })
    
    return savePath
  }
  
  async updateModel() {
    if (await this.checkUpdate()) {
      const url = 'https://cdn.example.com/models/latest.ms'
      const modelPath = await this.downloadModel(url)
      
      // åŠ è½½æ–°æ¨¡å‹
      await modelManager.load({ path: modelPath })
      
      // æ›´æ–°ç‰ˆæœ¬å·
      await this.saveVersion()
    }
  }
}
```

## âš¡ æ¨¡å‹ä¼˜åŒ–

### é‡åŒ–ä¼˜åŒ–

```typescript
// ä½¿ç”¨ FP16 åŠç²¾åº¦
const model = await modelManager.load({
  path: modelPath,
  precision: 'FP16'  // å‡å°‘å†…å­˜ï¼Œæå‡é€Ÿåº¦
})
```

### ç¡¬ä»¶åŠ é€Ÿ

```typescript
// å¯ç”¨ NPU åŠ é€Ÿ
const config = {
  path: modelPath,
  enableNPU: true,      // NPU åŠ é€Ÿ
  enableGPU: false,     // GPU åŠ é€Ÿ
  threads: 4            // CPU çº¿ç¨‹æ•°
}

const model = await modelManager.load(config)
```

## ğŸ¯ å®æˆ˜æ¡ˆä¾‹ï¼šè‡ªå®šä¹‰å›¾åƒåˆ†ç±»

```typescript
class CustomImageClassifier {
  private model: Model
  private labels: string[] = []
  
  async init() {
    // åŠ è½½æ¨¡å‹
    this.model = await modelManager.load({
      path: '/data/storage/el2/base/files/custom_classifier.ms',
      enableNPU: true,
      precision: 'FP16'
    })
    
    // åŠ è½½æ ‡ç­¾
    this.labels = await this.loadLabels()
  }
  
  async loadLabels(): Promise<string[]> {
    const labelsPath = '/data/storage/el2/base/files/labels.txt'
    const content = await fs.readFile(labelsPath)
    return content.split('\n')
  }
  
  async classify(imagePath: string) {
    // 1. åŠ è½½å›¾åƒ
    const image = await this.loadImage(imagePath)
    
    // 2. é¢„å¤„ç†
    const input = await this.preprocess(image)
    
    // 3. æ¨ç†
    const output = await this.model.infer(input)
    
    // 4. åå¤„ç†
    const results = this.postprocess(output)
    
    return results
  }
  
  private async loadImage(path: string): Promise<ImageData> {
    // åŠ è½½å›¾åƒ
    return await image.load(path)
  }
  
  private async preprocess(image: ImageData): Promise<ArrayBuffer> {
    // è°ƒæ•´å¤§å°åˆ° 224x224
    const resized = await image.resize(224, 224)
    
    // å½’ä¸€åŒ– [0, 1]
    const normalized = resized.normalize()
    
    // è½¬æ¢ä¸ºæ¨¡å‹è¾“å…¥æ ¼å¼
    return normalized.toArrayBuffer()
  }
  
  private postprocess(output: ArrayBuffer): ClassifyResult[] {
    const probabilities = new Float32Array(output)
    
    // è·å– Top-5
    const results: ClassifyResult[] = []
    const indices = this.getTopK(probabilities, 5)
    
    indices.forEach((index, rank) => {
      results.push({
        label: this.labels[index],
        confidence: probabilities[index],
        rank: rank + 1
      })
    })
    
    return results
  }
  
  private getTopK(arr: Float32Array, k: number): number[] {
    const indexed = Array.from(arr).map((val, idx) => ({ val, idx }))
    indexed.sort((a, b) => b.val - a.val)
    return indexed.slice(0, k).map(item => item.idx)
  }
}

// ä½¿ç”¨
const classifier = new CustomImageClassifier()
await classifier.init()

const results = await classifier.classify('/path/to/image.jpg')
results.forEach(result => {
  console.log(`${result.rank}. ${result.label}: ${result.confidence.toFixed(2)}`)
})
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æ¨¡å‹ç‰ˆæœ¬ç®¡ç†

```typescript
interface ModelInfo {
  version: string
  path: string
  updateTime: number
}

class ModelVersionManager {
  async getCurrentModel(): Promise<ModelInfo> {
    const info = await preferences.get('currentModel')
    return JSON.parse(info)
  }
  
  async updateModel(newModel: ModelInfo) {
    await preferences.put('currentModel', JSON.stringify(newModel))
  }
}
```

### 2. æ¨¡å‹é¢„çƒ­

```typescript
// é¦–æ¬¡æ¨ç†è¾ƒæ…¢ï¼Œæå‰é¢„çƒ­
async function warmupModel(model: Model) {
  const dummyInput = new ArrayBuffer(224 * 224 * 3 * 4)
  await model.infer(dummyInput)
}
```

### 3. å†…å­˜ç®¡ç†

```typescript
// åŠæ—¶é‡Šæ”¾æ¨¡å‹
onDestroy() {
  if (this.model) {
    this.model.release()
  }
}
```

## ğŸ“š å‚è€ƒèµ„æº

- [MindSpore Liteæ¨ç†](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/mindspore-lite-guidelines-0000001774121034-V5)

---

**ä¸‹ä¸€èŠ‚** â†’ [AIåº”ç”¨å®æˆ˜](07-AIåº”ç”¨å®æˆ˜.md)
