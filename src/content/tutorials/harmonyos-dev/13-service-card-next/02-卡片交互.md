---
title: å¡ç‰‡äº¤äº’
date: 2025-01-22
prevChapter: "harmonyos-dev/13-service-card-next/01-æœåŠ¡å¡ç‰‡å¼€å‘"
nextChapter: "harmonyos-dev/13-service-card-next/03-å¡ç‰‡æœ€ä½³å®è·µ"
parentChapter: "harmonyos-dev/13-service-card-next/README"
---
# å¡ç‰‡äº¤äº’

> å®ç°å¡ç‰‡ä¸åº”ç”¨çš„äº¤äº’

## ğŸ”— å¡ç‰‡äº‹ä»¶

### postCardAction å‘é€äº‹ä»¶

```typescript
import { postCardAction } from '@kit.FormKit'

// æ¶ˆæ¯äº‹ä»¶
postCardAction(this, {
  action: formInfo.FormAction.MESSAGE,
  params: JSON.stringify({
    method: 'refresh',
    data: { id: 123 }
  })
})

// è·¯ç”±äº‹ä»¶
postCardAction(this, {
  action: formInfo.FormAction.ROUTER_EVENT,
  abilityName: 'MainAbility',
  params: {
    page: 'pages/Detail',
    id: 123
  }
})
```

## ğŸ¯ ç‚¹å‡»è·³è½¬

### è·³è½¬åˆ°åº”ç”¨é¡µé¢

```typescript
@Entry
@Component
struct WeatherCard {
  build() {
    Column() {
      Text('æŸ¥çœ‹è¯¦æƒ…')
        .onClick(() => {
          postCardAction(this, {
            action: formInfo.FormAction.ROUTER_EVENT,
            abilityName: 'EntryAbility',
            params: {
              page: 'pages/WeatherDetail',
              city: 'åŒ—äº¬'
            }
          })
        })
    }
  }
}

// åº”ç”¨ä¸­å¤„ç†è·³è½¬
export default class EntryAbility extends UIAbility {
  onNewWant(want, launchParam) {
    if (launchParam.launchReason === AbilityConstant.LaunchReason.CARD) {
      const params = want.parameters
      const page = params?.['page']
      const city = params?.['city']
      
      // è·³è½¬åˆ°æŒ‡å®šé¡µé¢
      router.pushUrl({
        url: page,
        params: { city }
      })
    }
  }
}
```

## ğŸ”„ åŠ¨æ€æ›´æ–°

### ä¸»åŠ¨æ›´æ–°å¡ç‰‡æ•°æ®

```typescript
import { formProvider, formBindingData } from '@kit.FormKit'

class WeatherService {
  async updateWeatherCard(formId: string) {
    // è·å–æœ€æ–°æ•°æ®
    const weatherData = await this.fetchWeather()
    
    // æ›´æ–°å¡ç‰‡
    const formData = {
      temperature: weatherData.temp,
      weather: weatherData.condition,
      updateTime: new Date().toLocaleTimeString()
    }
    
    try {
      await formProvider.updateForm(
        formId,
        formBindingData.createFormBindingData(formData)
      )
      console.log('å¡ç‰‡æ›´æ–°æˆåŠŸ')
    } catch (err) {
      console.error('å¡ç‰‡æ›´æ–°å¤±è´¥:', err)
    }
  }
  
  async fetchWeather() {
    // è°ƒç”¨å¤©æ°”API
    return {
      temp: '28Â°C',
      condition: 'æ™´å¤©'
    }
  }
}
```

### æ‰¹é‡æ›´æ–°å¤šä¸ªå¡ç‰‡

```typescript
async function updateAllCards() {
  // è·å–æ‰€æœ‰å¡ç‰‡ID
  const formIds = await formHost.getAllFormsInfo()
  
  for (const formInfo of formIds) {
    await updateWeatherCard(formInfo.formId)
  }
}
```

## â° å®šæ—¶åˆ·æ–°

### åå°å®šæ—¶ä»»åŠ¡

```typescript
import { backgroundTaskManager } from '@kit.BackgroundTasksKit'

class CardUpdateService {
  private timerId: number = -1
  
  startPeriodicUpdate() {
    // ç”³è¯·åå°é•¿æ—¶ä»»åŠ¡
    backgroundTaskManager.requestBackgroundRunning(getContext(), {
      bgMode: backgroundTaskManager.BackgroundMode.DATA_TRANSFER,
      wantAgent: null
    }, (err) => {
      if (!err) {
        // å¯åŠ¨å®šæ—¶å™¨
        this.timerId = setInterval(() => {
          this.updateAllCards()
        }, 30 * 60 * 1000)  // æ¯30åˆ†é’Ÿæ›´æ–°
      }
    })
  }
  
  stopPeriodicUpdate() {
    if (this.timerId >= 0) {
      clearInterval(this.timerId)
      this.timerId = -1
    }
    
    backgroundTaskManager.stopBackgroundRunning(getContext())
  }
  
  async updateAllCards() {
    const formIds = await this.getAllCardIds()
    
    for (const formId of formIds) {
      await this.updateCard(formId)
    }
  }
}
```

## ğŸ¯ å®æˆ˜æ¡ˆä¾‹ï¼šéŸ³ä¹æ’­æ”¾å¡ç‰‡

```typescript
// FormExtensionAbility
export default class MusicFormAbility extends FormExtensionAbility {
  private musicPlayer: MusicPlayer = new MusicPlayer()
  
  onAddForm(want: Want) {
    const currentSong = this.musicPlayer.getCurrentSong()
    
    const formData = {
      title: currentSong?.title || 'æœªæ’­æ”¾',
      artist: currentSong?.artist || '--',
      isPlaying: this.musicPlayer.isPlaying(),
      coverUrl: currentSong?.coverUrl || ''
    }
    
    return formBindingData.createFormBindingData(formData)
  }
  
  onFormEvent(formId: string, message: string) {
    const event = JSON.parse(message)
    
    switch (event.action) {
      case 'play':
        this.musicPlayer.play()
        this.updateCardData(formId)
        break
      
      case 'pause':
        this.musicPlayer.pause()
        this.updateCardData(formId)
        break
      
      case 'next':
        this.musicPlayer.next()
        this.updateCardData(formId)
        break
      
      case 'prev':
        this.musicPlayer.previous()
        this.updateCardData(formId)
        break
    }
  }
  
  async updateCardData(formId: string) {
    const currentSong = this.musicPlayer.getCurrentSong()
    
    const formData = {
      title: currentSong.title,
      artist: currentSong.artist,
      isPlaying: this.musicPlayer.isPlaying(),
      coverUrl: currentSong.coverUrl
    }
    
    await formProvider.updateForm(
      formId,
      formBindingData.createFormBindingData(formData)
    )
  }
}

// å¡ç‰‡UI
@Entry
@Component
struct MusicCard {
  @LocalStorageProp('title') title: string = 'æœªæ’­æ”¾'
  @LocalStorageProp('artist') artist: string = '--'
  @LocalStorageProp('isPlaying') isPlaying: boolean = false
  @LocalStorageProp('coverUrl') coverUrl: string = ''
  
  sendAction(action: string) {
    postCardAction(this, {
      action: formInfo.FormAction.MESSAGE,
      params: JSON.stringify({ action })
    })
  }
  
  build() {
    Column() {
      // å°é¢å’Œä¿¡æ¯
      Row({ space: 15 }) {
        Image(this.coverUrl || $r('app.media.default_cover'))
          .width(80)
          .height(80)
          .borderRadius(8)
        
        Column({ space: 5 }) {
          Text(this.title)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .maxLines(1)
          
          Text(this.artist)
            .fontSize(14)
            .fontColor(Color.Gray)
            .maxLines(1)
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .padding(15)
      
      // æ§åˆ¶æŒ‰é’®
      Row({ space: 20 }) {
        Button({ type: ButtonType.Circle }) {
          Image($r('app.media.icon_previous'))
            .width(24)
            .height(24)
        }
        .width(48)
        .height(48)
        .onClick(() => {
          this.sendAction('prev')
        })
        
        Button({ type: ButtonType.Circle }) {
          Image(this.isPlaying ? 
            $r('app.media.icon_pause') : 
            $r('app.media.icon_play')
          )
          .width(32)
          .height(32)
        }
        .width(56)
        .height(56)
        .onClick(() => {
          this.sendAction(this.isPlaying ? 'pause' : 'play')
        })
        
        Button({ type: ButtonType.Circle }) {
          Image($r('app.media.icon_next'))
            .width(24)
            .height(24)
        }
        .width(48)
        .height(48)
        .onClick(() => {
          this.sendAction('next')
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding({ bottom: 15 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    .borderRadius(16)
  }
}
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. äº‹ä»¶å¤„ç†

```typescript
// âœ… ä½¿ç”¨try-catchå¤„ç†äº‹ä»¶
onFormEvent(formId: string, message: string) {
  try {
    const event = JSON.parse(message)
    this.handleEvent(event)
  } catch (err) {
    console.error('äº‹ä»¶å¤„ç†å¤±è´¥:', err)
  }
}
```

### 2. æ›´æ–°é¢‘ç‡æ§åˆ¶

```typescript
// âœ… é¿å…é¢‘ç¹æ›´æ–°
private lastUpdateTime: Map<string, number> = new Map()

shouldUpdate(formId: string): boolean {
  const last = this.lastUpdateTime.get(formId) || 0
  const now = Date.now()
  
  if (now - last < 1000) {  // 1ç§’å†…ä¸é‡å¤æ›´æ–°
    return false
  }
  
  this.lastUpdateTime.set(formId, now)
  return true
}
```

### 3. é”™è¯¯å¤„ç†

```typescript
// âœ… ä¼˜é›…å¤„ç†æ›´æ–°å¤±è´¥
async updateCard(formId: string) {
  try {
    await formProvider.updateForm(formId, data)
  } catch (err) {
    console.error('æ›´æ–°å¤±è´¥:', err)
    // è®°å½•æ—¥å¿—ï¼Œä¸å½±å“å…¶ä»–å¡ç‰‡
  }
}
```

## ğŸ“š å‚è€ƒèµ„æº

- [å¡ç‰‡æ•°æ®äº¤äº’](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-ui-widget-event-formextensionability-0000001820880565-V5)
- [postCardAction](https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-app-form-formBindingData-0000001821000653-V5)

---

**ä¸‹ä¸€èŠ‚** â†’ [å¡ç‰‡æœ€ä½³å®è·µ](03-å¡ç‰‡æœ€ä½³å®è·µ.md)
