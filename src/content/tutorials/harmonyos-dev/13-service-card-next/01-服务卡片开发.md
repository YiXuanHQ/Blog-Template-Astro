---
title: æœåŠ¡å¡ç‰‡å¼€å‘
date: 2025-01-22
nextChapter: "harmonyos-dev/13-service-card-next/02-å¡ç‰‡äº¤äº’"
parentChapter: "harmonyos-dev/13-service-card-next/README"
---
# æœåŠ¡å¡ç‰‡å¼€å‘

> å¼€å‘æ¡Œé¢æœåŠ¡å¡ç‰‡

## ğŸ“‡ å¡ç‰‡æ¦‚è¿°

æœåŠ¡å¡ç‰‡ï¼ˆWidgetï¼‰æ˜¯ä¸€ç§è½»é‡çº§çš„åº”ç”¨å±•ç¤ºå½¢å¼ï¼Œå¯ä»¥åœ¨æ¡Œé¢ç›´æ¥æ˜¾ç¤ºä¿¡æ¯å’Œæä¾›å¿«æ·æ“ä½œã€‚

### å¡ç‰‡ç±»å‹

```
å¡ç‰‡è§„æ ¼
â”œâ”€ 2x2ï¼ˆå°å¡ç‰‡ï¼‰
â”œâ”€ 2x4ï¼ˆä¸­ç­‰å¡ç‰‡ï¼‰
â”œâ”€ 4x4ï¼ˆå¤§å¡ç‰‡ï¼‰
â””â”€ è‡ªå®šä¹‰å°ºå¯¸
```

## ğŸ”§ åˆ›å»º FormExtensionAbility

### é…ç½® module.json5

```json5
{
  "module": {
    "extensionAbilities": [
      {
        "name": "WeatherFormAbility",
        "srcEntry": "./ets/weatherformability/WeatherFormAbility.ets",
        "type": "form",
        "metadata": [
          {
            "name": "ohos.extension.form",
            "resource": "$profile:form_config"
          }
        ]
      }
    ]
  }
}
```

### å¡ç‰‡é…ç½®æ–‡ä»¶

```json5
// resources/base/profile/form_config.json
{
  "forms": [
    {
      "name": "WeatherCard",
      "description": "å¤©æ°”å¡ç‰‡",
      "src": "./ets/widget/pages/WeatherCard.ets",
      "uiSyntax": "arkts",
      "window": {
        "designWidth": 720,
        "autoDesignWidth": true
      },
      "colorMode": "auto",
      "isDefault": true,
      "updateEnabled": true,
      "scheduledUpdateTime": "10:30",
      "updateDuration": 1,
      "defaultDimension": "2*2",
      "supportDimensions": ["2*2", "4*4"]
    }
  ]
}
```

## ğŸ“ å®ç° FormExtensionAbility

```typescript
import { FormExtensionAbility, formBindingData, formInfo } from '@kit.FormKit'

export default class WeatherFormAbility extends FormExtensionAbility {
  // åˆ›å»ºå¡ç‰‡
  onAddForm(want: Want) {
    console.log('åˆ›å»ºå¡ç‰‡')
    
    // è·å–å¡ç‰‡ä¿¡æ¯
    const formId = want.parameters!['ohos.extra.param.key.form_identity'] as string
    const formName = want.parameters!['ohos.extra.param.key.form_name'] as string
    const dimension = want.parameters!['ohos.extra.param.key.form_dimension'] as number
    
    // å‡†å¤‡å¡ç‰‡æ•°æ®
    const formData = {
      temperature: '25Â°C',
      weather: 'æ™´å¤©',
      city: 'åŒ—äº¬',
      updateTime: new Date().toLocaleTimeString()
    }
    
    // è¿”å›å¡ç‰‡æ•°æ®
    return formBindingData.createFormBindingData(formData)
  }
  
  // æ›´æ–°å¡ç‰‡
  onUpdateForm(formId: string) {
    console.log('æ›´æ–°å¡ç‰‡:', formId)
    
    // è·å–æœ€æ–°æ•°æ®
    const formData = {
      temperature: '26Â°C',
      weather: 'å¤šäº‘',
      city: 'åŒ—äº¬',
      updateTime: new Date().toLocaleTimeString()
    }
    
    return formBindingData.createFormBindingData(formData)
  }
  
  // åˆ é™¤å¡ç‰‡
  onRemoveForm(formId: string) {
    console.log('åˆ é™¤å¡ç‰‡:', formId)
  }
  
  // å¡ç‰‡å¯è§æ€§å˜åŒ–
  onVisibilityChange(formEventsMap: Map<string, number>) {
    console.log('å¡ç‰‡å¯è§æ€§å˜åŒ–')
    
    formEventsMap.forEach((value, key) => {
      if (value === formInfo.FormVisibilityType.FORM_VISIBLE) {
        console.log('å¡ç‰‡å¯è§:', key)
      } else {
        console.log('å¡ç‰‡ä¸å¯è§:', key)
      }
    })
  }
  
  // å¡ç‰‡äº‹ä»¶å¤„ç†
  onFormEvent(formId: string, message: string) {
    console.log('æ”¶åˆ°å¡ç‰‡äº‹ä»¶:', formId, message)
    
    // å¤„ç†å¡ç‰‡æ¶ˆæ¯
    const event = JSON.parse(message)
    if (event.action === 'refresh') {
      // åˆ·æ–°å¡ç‰‡
      this.updateFormData(formId)
    }
  }
  
  // æ›´æ–°å¡ç‰‡æ•°æ®
  async updateFormData(formId: string) {
    const formData = await this.fetchWeatherData()
    
    try {
      formProvider.updateForm(formId, formBindingData.createFormBindingData(formData))
    } catch (err) {
      console.error('æ›´æ–°å¡ç‰‡å¤±è´¥:', err)
    }
  }
  
  // è·å–å¤©æ°”æ•°æ®
  async fetchWeatherData() {
    // å®é™…åº”è¯¥è°ƒç”¨å¤©æ°”API
    return {
      temperature: '27Â°C',
      weather: 'é˜´å¤©',
      city: 'åŒ—äº¬',
      updateTime: new Date().toLocaleTimeString()
    }
  }
}
```

## ğŸ¨ å¡ç‰‡é¡µé¢

### å¡ç‰‡UI

```typescript
@Entry
@Component
struct WeatherCard {
  @LocalStorageProp('temperature') temperature: string = '--'
  @LocalStorageProp('weather') weather: string = '--'
  @LocalStorageProp('city') city: string = '--'
  @LocalStorageProp('updateTime') updateTime: string = '--'
  
  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text(this.city)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        Text(this.updateTime)
          .fontSize(12)
          .fontColor(Color.Gray)
      }
      .width('100%')
      .padding({ left: 15, right: 15, top: 10 })
      
      // ä¸»è¦å†…å®¹
      Column({ space: 5 }) {
        Text(this.temperature)
          .fontSize(48)
          .fontWeight(FontWeight.Bold)
          .fontColor('#007DFF')
        
        Text(this.weather)
          .fontSize(18)
          .fontColor(Color.Gray)
      }
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
      
      // æ“ä½œæŒ‰é’®
      Row() {
        Button('åˆ·æ–°')
          .fontSize(14)
          .height(32)
          .onClick(() => {
            // å‘é€åˆ·æ–°äº‹ä»¶
            postCardAction(this, {
              action: formInfo.FormAction.ROUTER_EVENT,
              abilityName: 'WeatherFormAbility',
              params: {
                method: 'refresh'
              }
            })
          })
      }
      .width('100%')
      .padding({ left: 15, right: 15, bottom: 10 })
      .justifyContent(FlexAlign.End)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    .borderRadius(16)
  }
}
```

## ğŸ”„ å®šæ—¶æ›´æ–°

### é…ç½®å®šæ—¶æ›´æ–°

```json5
{
  "forms": [{
    "updateEnabled": true,
    "scheduledUpdateTime": "10:30",  // æ¯å¤©10:30æ›´æ–°
    "updateDuration": 1  // æ¯å°æ—¶æ›´æ–°ä¸€æ¬¡
  }]
}
```

### ä¸»åŠ¨æ›´æ–°å¡ç‰‡

```typescript
import { formProvider } from '@kit.FormKit'

async function updateForm(formId: string) {
  const formData = {
    temperature: '28Â°C',
    weather: 'æ™´è½¬å¤šäº‘',
    updateTime: new Date().toLocaleTimeString()
  }
  
  try {
    await formProvider.updateForm(formId, formBindingData.createFormBindingData(formData))
    console.log('æ›´æ–°æˆåŠŸ')
  } catch (err) {
    console.error('æ›´æ–°å¤±è´¥:', err)
  }
}
```

## ğŸ¯ å®æˆ˜æ¡ˆä¾‹ï¼šå¾…åŠäº‹é¡¹å¡ç‰‡

```typescript
// FormExtensionAbility
export default class TodoFormAbility extends FormExtensionAbility {
  onAddForm(want: Want) {
    const todos = this.getTodoList()
    
    const formData = {
      todos: JSON.stringify(todos),
      totalCount: todos.length,
      doneCount: todos.filter(t => t.done).length
    }
    
    return formBindingData.createFormBindingData(formData)
  }
  
  onFormEvent(formId: string, message: string) {
    const event = JSON.parse(message)
    
    if (event.action === 'toggleTodo') {
      this.toggleTodo(event.todoId)
      this.updateFormData(formId)
    } else if (event.action === 'openApp') {
      // æ‹‰èµ·åº”ç”¨
      this.context.startAbility({
        bundleName: 'com.example.todoapp',
        abilityName: 'MainAbility'
      })
    }
  }
  
  getTodoList(): Todo[] {
    // ä»æ•°æ®åº“è¯»å–
    return [
      { id: 1, text: 'å®Œæˆé¡¹ç›®æ–‡æ¡£', done: false },
      { id: 2, text: 'å‚åŠ ä¼šè®®', done: true },
      { id: 3, text: 'ä»£ç review', done: false }
    ]
  }
  
  toggleTodo(todoId: number) {
    // æ›´æ–°æ•°æ®åº“
  }
}

// å¡ç‰‡é¡µé¢
@Entry
@Component
struct TodoCard {
  @LocalStorageProp('todos') todosStr: string = '[]'
  @LocalStorageProp('totalCount') totalCount: number = 0
  @LocalStorageProp('doneCount') doneCount: number = 0
  
  get todos(): Todo[] {
    try {
      return JSON.parse(this.todosStr)
    } catch {
      return []
    }
  }
  
  build() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Text('å¾…åŠäº‹é¡¹')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        Text(`${this.doneCount}/${this.totalCount}`)
          .fontSize(14)
          .fontColor(Color.Gray)
      }
      .width('100%')
      .padding(15)
      
      // å¾…åŠåˆ—è¡¨
      List({ space: 8 }) {
        ForEach(this.todos.slice(0, 3), (todo: Todo) => {
          ListItem() {
            Row({ space: 10 }) {
              Checkbox()
                .select(todo.done)
                .onChange((checked) => {
                  postCardAction(this, {
                    action: formInfo.FormAction.MESSAGE,
                    params: JSON.stringify({
                      action: 'toggleTodo',
                      todoId: todo.id
                    })
                  })
                })
              
              Text(todo.text)
                .fontSize(14)
                .decoration({
                  type: todo.done ? TextDecorationType.LineThrough : TextDecorationType.None
                })
                .layoutWeight(1)
            }
            .width('100%')
          }
        })
      }
      .layoutWeight(1)
      .padding({ left: 15, right: 15 })
      
      // åº•éƒ¨æŒ‰é’®
      Button('æ‰“å¼€åº”ç”¨')
        .width('90%')
        .margin({ bottom: 10 })
        .onClick(() => {
          postCardAction(this, {
            action: formInfo.FormAction.ROUTER_EVENT,
            params: { action: 'openApp' }
          })
        })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    .borderRadius(16)
  }
}

interface Todo {
  id: number
  text: string
  done: boolean
}
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å¡ç‰‡å¤§å°é™åˆ¶

```typescript
// âœ… æ§åˆ¶å¡ç‰‡æ•°æ®å¤§å°ï¼ˆ<1MBï¼‰
const formData = {
  title: 'xxx',
  content: 'xxx'  // ç²¾ç®€æ•°æ®
}
```

### 2. æ€§èƒ½ä¼˜åŒ–

```typescript
// âœ… é¿å…é¢‘ç¹æ›´æ–°
let lastUpdateTime = 0
const UPDATE_INTERVAL = 30000  // 30ç§’

function shouldUpdate(): boolean {
  const now = Date.now()
  if (now - lastUpdateTime > UPDATE_INTERVAL) {
    lastUpdateTime = now
    return true
  }
  return false
}
```

### 3. ç”µæ± ä¼˜åŒ–

```json5
// âœ… åˆç†è®¾ç½®æ›´æ–°é¢‘ç‡
{
  "updateDuration": 4  // 4å°æ—¶æ›´æ–°ä¸€æ¬¡
}
```

## ğŸ“š å‚è€ƒèµ„æº

- [æœåŠ¡å¡ç‰‡å¼€å‘](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-ui-widget-working-principles-0000001820880617-V5)
- [FormExtensionAbility](https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-app-form-formextensionability-0000001774121018-V5)

---

**ä¸‹ä¸€èŠ‚** â†’ [å¡ç‰‡äº¤äº’](02-å¡ç‰‡äº¤äº’.md)
