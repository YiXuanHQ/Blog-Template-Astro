---
title: åˆ†å¸ƒå¼æ•°æ®æœåŠ¡
date: 2025-01-22
prevChapter: "harmonyos-dev/07-data-management/02-å…³ç³»å‹æ•°æ®åº“"
parentChapter: "harmonyos-dev/07-data-management/README"
---
# åˆ†å¸ƒå¼æ•°æ®æœåŠ¡

> è·¨è®¾å¤‡æ•°æ®åŒæ­¥

## ğŸŒ åˆ†å¸ƒå¼æ•°æ®æ¦‚è¿°

åˆ†å¸ƒå¼æ•°æ®æœåŠ¡æ”¯æŒåœ¨å¤šè®¾å¤‡é—´è‡ªåŠ¨åŒæ­¥æ•°æ®ã€‚

### æ ¸å¿ƒç‰¹æ€§

```
åˆ†å¸ƒå¼æ•°æ®æœåŠ¡
â”œâ”€ è‡ªåŠ¨åŒæ­¥ï¼ˆæ— éœ€æ‰‹åŠ¨å¤„ç†ï¼‰
â”œâ”€ æ•°æ®ä¸€è‡´æ€§ï¼ˆæœ€ç»ˆä¸€è‡´ï¼‰
â”œâ”€ å†²çªè§£å†³ï¼ˆè‡ªåŠ¨/æ‰‹åŠ¨ï¼‰
â””â”€ ç¦»çº¿æ”¯æŒï¼ˆæ–­ç½‘åæ¢å¤åŒæ­¥ï¼‰
```

## ğŸ”§ åˆ†å¸ƒå¼æ•°æ®åº“

### åˆ›å»ºåˆ†å¸ƒå¼æ•°æ®åº“

```typescript
import distributedKVStore from '@ohos.data.distributedKVStore'

// KVå­˜å‚¨é…ç½®
const kvManagerConfig = {
  context: context,
  bundleName: 'com.example.myapp'
}

// åˆ›å»º KVManager
const kvManager = distributedKVStore.createKVManager(kvManagerConfig)

// æ•°æ®åº“é…ç½®
const options = {
  createIfMissing: true,
  encrypt: false,
  backup: false,
  autoSync: true,  // è‡ªåŠ¨åŒæ­¥
  kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
  securityLevel: distributedKVStore.SecurityLevel.S1
}

// åˆ›å»ºåˆ†å¸ƒå¼æ•°æ®åº“
const kvStore = await kvManager.getKVStore('myStore', options)
```

### å†™å…¥æ•°æ®

```typescript
// å†™å…¥å•ä¸ªé”®å€¼å¯¹
await kvStore.put('username', 'Alice')
await kvStore.put('age', 25)

// å†™å…¥å¯¹è±¡ï¼ˆéœ€è¦åºåˆ—åŒ–ï¼‰
const user = {
  name: 'Alice',
  age: 25,
  email: 'alice@example.com'
}
await kvStore.put('user', JSON.stringify(user))
```

### è¯»å–æ•°æ®

```typescript
// è¯»å–å•ä¸ªå€¼
const username = await kvStore.get('username')
console.log('ç”¨æˆ·å:', username)

// è¯»å–å¹¶è§£æå¯¹è±¡
const userStr = await kvStore.get('user')
const user = JSON.parse(userStr)
console.log('ç”¨æˆ·:', user)
```

### åˆ é™¤æ•°æ®

```typescript
// åˆ é™¤å•ä¸ªé”®
await kvStore.delete('username')

// åˆ é™¤å¤šä¸ªé”®
await kvStore.deleteBatch(['key1', 'key2', 'key3'])
```

## ğŸ”„ æ•°æ®åŒæ­¥

### è‡ªåŠ¨åŒæ­¥

```typescript
// åˆ›å»ºæ—¶å¯ç”¨è‡ªåŠ¨åŒæ­¥
const options = {
  autoSync: true,  // è‡ªåŠ¨åŒæ­¥åˆ°å…¶ä»–è®¾å¤‡
  // ... å…¶ä»–é…ç½®
}

const kvStore = await kvManager.getKVStore('syncStore', options)

// å†™å…¥æ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥
await kvStore.put('sharedData', 'This data will sync')
```

### æ‰‹åŠ¨åŒæ­¥

```typescript
import deviceManager from '@ohos.distributedDeviceManager'

// è·å–å¯ç”¨è®¾å¤‡åˆ—è¡¨
const dmInstance = deviceManager.createDeviceManager('com.example.myapp')
const devices = dmInstance.getAvailableDeviceListSync()

// åŒæ­¥åˆ°æŒ‡å®šè®¾å¤‡
const deviceIds = devices.map(d => d.deviceId)
await kvStore.sync(deviceIds, distributedKVStore.SyncMode.PUSH_PULL)
```

### ç›‘å¬åŒæ­¥å®Œæˆ

```typescript
// ç›‘å¬åŒæ­¥å®Œæˆäº‹ä»¶
kvStore.on('syncComplete', (data) => {
  console.log('åŒæ­¥å®Œæˆ')
  
  data.forEach((result) => {
    console.log('è®¾å¤‡:', result.deviceId)
    console.log('çŠ¶æ€:', result.status)
  })
})
```

## ğŸ¯ å®æˆ˜æ¡ˆä¾‹

### è·¨è®¾å¤‡å¾…åŠäº‹é¡¹

```typescript
import distributedKVStore from '@ohos.data.distributedKVStore'

class DistributedTodoStore {
  private kvStore: distributedKVStore.SingleKVStore
  private kvManager: distributedKVStore.KVManager
  
  async init(context) {
    // åˆ›å»º KVManager
    const config = {
      context: context,
      bundleName: 'com.example.todoapp'
    }
    this.kvManager = distributedKVStore.createKVManager(config)
    
    // åˆ›å»ºåˆ†å¸ƒå¼æ•°æ®åº“
    const options = {
      createIfMissing: true,
      encrypt: false,
      backup: true,
      autoSync: true,
      kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
      securityLevel: distributedKVStore.SecurityLevel.S1
    }
    
    this.kvStore = await this.kvManager.getKVStore('todoStore', options)
    
    // ç›‘å¬æ•°æ®å˜åŒ–
    this.kvStore.on('dataChange', distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data) => {
      console.log('æ•°æ®å˜åŒ–:', data)
      this.handleDataChange(data)
    })
  }
  
  // æ·»åŠ å¾…åŠ
  async addTodo(todo: Todo) {
    const key = `todo_${todo.id}`
    await this.kvStore.put(key, JSON.stringify(todo))
  }
  
  // è·å–æ‰€æœ‰å¾…åŠ
  async getAllTodos(): Promise<Todo[]> {
    const entries = await this.kvStore.getEntries('todo_')
    
    const todos: Todo[] = []
    entries.forEach((entry) => {
      try {
        const todo = JSON.parse(entry.value.value)
        todos.push(todo)
      } catch (err) {
        console.error('è§£æå¤±è´¥:', err)
      }
    })
    
    return todos.sort((a, b) => a.createdAt - b.createdAt)
  }
  
  // æ›´æ–°å¾…åŠ
  async updateTodo(id: string, updates: Partial<Todo>) {
    const key = `todo_${id}`
    const todoStr = await this.kvStore.get(key)
    
    if (todoStr) {
      const todo = JSON.parse(todoStr)
      const updated = { ...todo, ...updates }
      await this.kvStore.put(key, JSON.stringify(updated))
    }
  }
  
  // åˆ é™¤å¾…åŠ
  async deleteTodo(id: string) {
    const key = `todo_${id}`
    await this.kvStore.delete(key)
  }
  
  // å¤„ç†æ•°æ®å˜åŒ–
  private handleDataChange(data) {
    // é€šçŸ¥UIæ›´æ–°
    console.log('å…¶ä»–è®¾å¤‡åŒæ­¥äº†æ•°æ®')
  }
  
  // åŒæ­¥åˆ°æŒ‡å®šè®¾å¤‡
  async syncToDevice(deviceId: string) {
    await this.kvStore.sync([deviceId], distributedKVStore.SyncMode.PUSH_PULL)
  }
}

interface Todo {
  id: string
  title: string
  done: boolean
  createdAt: number
}

// ä½¿ç”¨
@Entry
@Component
struct TodoApp {
  private todoStore: DistributedTodoStore = new DistributedTodoStore()
  @State todos: Todo[] = []
  
  async aboutToAppear() {
    await this.todoStore.init(getContext(this))
    await this.loadTodos()
  }
  
  async loadTodos() {
    this.todos = await this.todoStore.getAllTodos()
  }
  
  async addTodo(title: string) {
    const todo: Todo = {
      id: Date.now().toString(),
      title: title,
      done: false,
      createdAt: Date.now()
    }
    
    await this.todoStore.addTodo(todo)
    await this.loadTodos()
  }
  
  async toggleTodo(id: string) {
    const todo = this.todos.find(t => t.id === id)
    if (todo) {
      await this.todoStore.updateTodo(id, { done: !todo.done })
      await this.loadTodos()
    }
  }
  
  build() {
    Column() {
      Text('è·¨è®¾å¤‡å¾…åŠäº‹é¡¹')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
      
      List() {
        ForEach(this.todos, (todo: Todo) => {
          ListItem() {
            Row({ space: 10 }) {
              Checkbox()
                .select(todo.done)
                .onChange((checked) => {
                  this.toggleTodo(todo.id)
                })
              
              Text(todo.title)
                .decoration({
                  type: todo.done ? TextDecorationType.LineThrough : TextDecorationType.None
                })
            }
            .padding(10)
          }
        })
      }
      
      Text('æ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥åˆ°å…¶ä»–è®¾å¤‡')
        .fontSize(12)
        .fontColor(Color.Gray)
        .margin({ top: 10 })
    }
    .padding(20)
  }
}
```

## âš–ï¸ å†²çªè§£å†³

### è‡ªåŠ¨è§£å†³

```typescript
// é»˜è®¤ç­–ç•¥ï¼šæœ€åå†™å…¥è·èƒœï¼ˆLast Write Winsï¼‰
// æ—¶é—´æˆ³è¶Šæ–°çš„æ•°æ®ä¼šè¦†ç›–æ—§æ•°æ®
```

### æ‰‹åŠ¨è§£å†³

```typescript
kvStore.on('dataChange', distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, async (data) => {
  for (const entry of data.updateEntries) {
    const key = entry.key
    const localValue = await kvStore.get(key)
    const remoteValue = entry.value.value
    
    // è‡ªå®šä¹‰å†²çªè§£å†³é€»è¾‘
    const resolved = resolveConflict(localValue, remoteValue)
    await kvStore.put(key, resolved)
  }
})

function resolveConflict(local, remote) {
  // è‡ªå®šä¹‰è§£å†³ç­–ç•¥
  // ä¾‹å¦‚ï¼šåˆå¹¶æ•°æ®ã€é€‰æ‹©è¾ƒå¤§å€¼ç­‰
  return local  // æˆ– remote
}
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. åˆç†ä½¿ç”¨åˆ†å¸ƒå¼æ•°æ®åº“

```typescript
// âœ… é€‚åˆåˆ†å¸ƒå¼å­˜å‚¨
- ç”¨æˆ·åå¥½è®¾ç½®
- å¾…åŠäº‹é¡¹
- ç¬”è®°æ•°æ®
- è´­ç‰©æ¸…å•

// âŒ ä¸é€‚åˆåˆ†å¸ƒå¼å­˜å‚¨
- å¤§æ–‡ä»¶
- æ•æ„Ÿæ•°æ®
- ä¸´æ—¶æ•°æ®
```

### 2. æ•°æ®ç‰ˆæœ¬ç®¡ç†

```typescript
interface DataWithVersion {
  data: any
  version: number
  updatedAt: number
}

async function putWithVersion(key: string, data: any) {
  const item: DataWithVersion = {
    data: data,
    version: 1,
    updatedAt: Date.now()
  }
  
  await kvStore.put(key, JSON.stringify(item))
}
```

### 3. é”™è¯¯å¤„ç†

```typescript
try {
  await kvStore.put('key', 'value')
} catch (err) {
  console.error('å†™å…¥å¤±è´¥:', err)
  // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
}
```

## ğŸ“š å‚è€ƒèµ„æº

- [åˆ†å¸ƒå¼æ•°æ®æœåŠ¡å®˜æ–¹æ–‡æ¡£](https://developer.harmonyos.com/cn/docs/documentation/doc-references-V3/js-apis-distributedkvstore-0000001428061992-V3)

---

**ç¬¬7ç« å®Œæˆï¼** ç»§ç»­å­¦ä¹  â†’ [ç¬¬8ç« ï¼šç½‘ç»œä¸è¿æ¥](../08-network-connect/)
