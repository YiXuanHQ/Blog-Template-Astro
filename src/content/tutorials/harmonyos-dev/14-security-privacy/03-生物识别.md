---
title: ç”Ÿç‰©è¯†åˆ«
date: 2025-01-22
prevChapter: "harmonyos-dev/14-security-privacy/02-æ•°æ®åŠ å¯†ä¸å­˜å‚¨"
parentChapter: "harmonyos-dev/14-security-privacy/README"
---
# ç”Ÿç‰©è¯†åˆ«

> å®ç°ç”Ÿç‰©è¯†åˆ«è®¤è¯

## ğŸ” ç»Ÿä¸€è®¤è¯æ¡†æ¶

### UserAuth è®¤è¯

```typescript
import { userAuth } from '@kit.UserAuthenticationKit'

class BiometricAuth {
  private authInstance: userAuth.UserAuthInstance | null = null
  
  // æ£€æŸ¥ç”Ÿç‰©è¯†åˆ«å¯ç”¨æ€§
  async checkBiometricAvailable(): Promise<boolean> {
    try {
      const authParam: userAuth.AuthParam = {
        challenge: new Uint8Array([1, 2, 3, 4]),
        authType: [userAuth.UserAuthType.FINGERPRINT, userAuth.UserAuthType.FACE],
        authTrustLevel: userAuth.AuthTrustLevel.ATL3
      }
      
      const widgetParam: userAuth.WidgetParam = {
        title: 'è¯·è¿›è¡Œç”Ÿç‰©è¯†åˆ«'
      }
      
      this.authInstance = userAuth.getUserAuthInstance(authParam, widgetParam)
      
      const availableStatus = await this.authInstance.checkAvailableStatus()
      return availableStatus === userAuth.UserAuthResultCode.SUCCESS
    } catch (err) {
      console.error('æ£€æŸ¥ç”Ÿç‰©è¯†åˆ«å¤±è´¥:', err)
      return false
    }
  }
  
  // å¼€å§‹è®¤è¯
  async authenticate(): Promise<boolean> {
    if (!this.authInstance) {
      await this.checkBiometricAvailable()
    }
    
    return new Promise((resolve) => {
      this.authInstance!.on('result', {
        onResult: (result) => {
          console.log('è®¤è¯ç»“æœ:', result.result)
          
          if (result.result === userAuth.UserAuthResultCode.SUCCESS) {
            resolve(true)
          } else {
            resolve(false)
          }
          
          // é‡Šæ”¾å®ä¾‹
          this.authInstance!.cancel()
          this.authInstance = null
        }
      })
      
      // å¼€å§‹è®¤è¯
      this.authInstance!.start()
    })
  }
  
  // å–æ¶ˆè®¤è¯
  cancelAuth() {
    if (this.authInstance) {
      this.authInstance.cancel()
      this.authInstance = null
    }
  }
}
```

## ğŸ¯ å®æˆ˜æ¡ˆä¾‹ï¼šç”Ÿç‰©è¯†åˆ«ç™»å½•

```typescript
@Entry
@Component
struct BiometricLoginPage {
  private biometricAuth: BiometricAuth = new BiometricAuth()
  @State hasBiometric: boolean = false
  @State username: string = ''
  
  async aboutToAppear() {
    this.hasBiometric = await this.biometricAuth.checkBiometricAvailable()
    
    // åŠ è½½ç”¨æˆ·å
    const savedUsername = await preferences.get('username', '')
    this.username = savedUsername as string
  }
  
  async loginWithBiometric() {
    if (!this.hasBiometric) {
      promptAction.showToast({
        message: 'è®¾å¤‡ä¸æ”¯æŒç”Ÿç‰©è¯†åˆ«'
      })
      return
    }
    
    try {
      const success = await this.biometricAuth.authenticate()
      
      if (success) {
        // è®¤è¯æˆåŠŸ
        promptAction.showToast({
          message: 'è®¤è¯æˆåŠŸ'
        })
        
        // è·³è½¬åˆ°é¦–é¡µ
        router.replaceUrl({ url: 'pages/Home' })
      } else {
        // è®¤è¯å¤±è´¥
        promptAction.showToast({
          message: 'è®¤è¯å¤±è´¥ï¼Œè¯·é‡è¯•'
        })
      }
    } catch (err) {
      console.error('ç”Ÿç‰©è¯†åˆ«é”™è¯¯:', err)
      promptAction.showToast({
        message: 'è®¤è¯å‡ºé”™'
      })
    }
  }
  
  build() {
    Column({ space: 30 }) {
      // Logo
      Image($r('app.media.app_icon'))
        .width(100)
        .height(100)
        .borderRadius(20)
      
      Text('æ¬¢è¿å›æ¥')
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
      
      if (this.username) {
        Text(this.username)
          .fontSize(18)
          .fontColor(Color.Gray)
      }
      
      // ç”Ÿç‰©è¯†åˆ«æŒ‰é’®
      if (this.hasBiometric) {
        Column({ space: 15 }) {
          Button() {
            Image($r('app.media.icon_fingerprint'))
              .width(48)
              .height(48)
          }
          .width(80)
          .height(80)
          .borderRadius(40)
          .backgroundColor(0x007DFF)
          .onClick(() => {
            this.loginWithBiometric()
          })
          
          Text('ä½¿ç”¨ç”Ÿç‰©è¯†åˆ«ç™»å½•')
            .fontSize(14)
            .fontColor(Color.Gray)
        }
      }
      
      Divider()
        .width('80%')
      
      // å¯†ç ç™»å½•
      Button('ä½¿ç”¨å¯†ç ç™»å½•')
        .width('80%')
        .type(ButtonType.Normal)
        .onClick(() => {
          router.pushUrl({ url: 'pages/PasswordLogin' })
        })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }
}
```

## ğŸ”‘ å®æˆ˜æ¡ˆä¾‹ï¼šæ”¯ä»˜éªŒè¯

```typescript
@Entry
@Component
struct PaymentPage {
  private biometricAuth: BiometricAuth = new BiometricAuth()
  @State amount: number = 99.00
  @State paymentMethod: string = 'æ”¯ä»˜å®'
  
  async confirmPayment() {
    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    const result = await promptAction.showDialog({
      title: 'ç¡®è®¤æ”¯ä»˜',
      message: `å‘${this.paymentMethod}æ”¯ä»˜ Â¥${this.amount.toFixed(2)}`,
      buttons: [
        { text: 'å–æ¶ˆ' },
        { text: 'ç¡®è®¤' }
      ]
    })
    
    if (result.index === 1) {
      // è¿›è¡Œç”Ÿç‰©è¯†åˆ«éªŒè¯
      await this.verifyAndPay()
    }
  }
  
  async verifyAndPay() {
    try {
      const success = await this.biometricAuth.authenticate()
      
      if (success) {
        // è®¤è¯æˆåŠŸï¼Œæ‰§è¡Œæ”¯ä»˜
        await this.processPayment()
        
        promptAction.showToast({
          message: 'æ”¯ä»˜æˆåŠŸ'
        })
        
        router.back()
      } else {
        promptAction.showToast({
          message: 'è®¤è¯å¤±è´¥ï¼Œæ”¯ä»˜å–æ¶ˆ'
        })
      }
    } catch (err) {
      console.error('æ”¯ä»˜éªŒè¯å¤±è´¥:', err)
    }
  }
  
  async processPayment() {
    // å®é™…æ”¯ä»˜é€»è¾‘
    console.log('å¤„ç†æ”¯ä»˜:', this.amount)
  }
  
  build() {
    Column({ space: 20 }) {
      Text('æ”¯ä»˜ç¡®è®¤')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
      
      Column({ space: 10 }) {
        Row() {
          Text('æ”¯ä»˜é‡‘é¢')
            .layoutWeight(1)
          
          Text(`Â¥${this.amount.toFixed(2)}`)
            .fontSize(28)
            .fontColor(Color.Red)
            .fontWeight(FontWeight.Bold)
        }
        .width('100%')
        
        Row() {
          Text('æ”¯ä»˜æ–¹å¼')
            .layoutWeight(1)
          
          Text(this.paymentMethod)
        }
        .width('100%')
      }
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(12)
      
      Button('ç¡®è®¤æ”¯ä»˜')
        .width('100%')
        .height(50)
        .onClick(() => {
          this.confirmPayment()
        })
    }
    .padding(20)
    .width('100%')
    .height('100%')
  }
}
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä¼˜é›…é™çº§

```typescript
async login() {
  const hasBiometric = await checkBiometricAvailable()
  
  if (hasBiometric) {
    // ä½¿ç”¨ç”Ÿç‰©è¯†åˆ«
    await biometricAuth()
  } else {
    // é™çº§åˆ°å¯†ç ç™»å½•
    await passwordAuth()
  }
}
```

### 2. é”™è¯¯å¤„ç†

```typescript
try {
  const success = await authenticate()
  if (success) {
    // æˆåŠŸå¤„ç†
  }
} catch (err) {
  if (err.code === 'BIOMETRIC_LOCKED') {
    showMessage('ç”Ÿç‰©è¯†åˆ«å·²é”å®šï¼Œè¯·ç¨åé‡è¯•')
  } else {
    showMessage('è®¤è¯å¤±è´¥')
  }
}
```

### 3. ç”¨æˆ·ä½“éªŒ

```typescript
// âœ… æä¾›å–æ¶ˆé€‰é¡¹
AlertDialog.show({
  title: 'ç”Ÿç‰©è¯†åˆ«',
  message: 'è¯·ä½¿ç”¨æŒ‡çº¹æˆ–é¢éƒ¨è¯†åˆ«',
  primaryButton: {
    value: 'å–æ¶ˆ',
    action: () => {
      biometricAuth.cancelAuth()
    }
  }
})
```

## ğŸ“š å‚è€ƒèµ„æº

- [ç”¨æˆ·è®¤è¯](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/userauth-guidelines-0000001821000549-V5)
- [UserAuth API](https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-useriam-userauth-0000001774121022-V5)

---

**ç¬¬14ç« å®Œæˆï¼** ç»§ç»­å­¦ä¹  â†’ [ç¬¬15ç« ï¼šæ€§èƒ½ä¼˜åŒ–](../15-performance-optimization/)
