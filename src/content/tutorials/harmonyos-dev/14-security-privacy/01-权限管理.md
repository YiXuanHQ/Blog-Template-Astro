---
title: æƒé™ç®¡ç†
date: 2025-01-22
nextChapter: "harmonyos-dev/14-security-privacy/02-æ•°æ®åŠ å¯†ä¸å­˜å‚¨"
parentChapter: "harmonyos-dev/14-security-privacy/README"
---
# æƒé™ç®¡ç†

> æ­£ç¡®ç”³è¯·å’Œä½¿ç”¨åº”ç”¨æƒé™

## ğŸ” æƒé™ç±»å‹

### HarmonyOS æƒé™åˆ†ç±»

```
æƒé™ç±»å‹
â”œâ”€ normalï¼ˆæ™®é€šæƒé™ï¼‰- è‡ªåŠ¨æˆäºˆ
â”œâ”€ system_basicï¼ˆç³»ç»ŸåŸºç¡€æƒé™ï¼‰- éœ€ç”¨æˆ·æˆæƒ
â”œâ”€ system_grantï¼ˆç³»ç»Ÿæˆæƒï¼‰- ACLé…ç½®
â””â”€ user_grantï¼ˆç”¨æˆ·æˆæƒï¼‰- è¿è¡Œæ—¶è¯·æ±‚
```

## ğŸ“ å£°æ˜æƒé™

### åœ¨ module.json5 ä¸­é…ç½®

```json5
{
  "module": {
    "requestPermissions": [
      {
        "name": "ohos.permission.INTERNET",
        "reason": "$string:reason_internet",
        "usedScene": {
          "abilities": ["EntryAbility"],
          "when": "inuse"
        }
      },
      {
        "name": "ohos.permission.CAMERA",
        "reason": "$string:reason_camera",
        "usedScene": {
          "abilities": ["EntryAbility"],
          "when": "inuse"
        }
      },
      {
        "name": "ohos.permission.LOCATION",
        "reason": "$string:reason_location",
        "usedScene": {
          "abilities": ["EntryAbility"],
          "when": "always"
        }
      }
    ]
  }
}
```

### æƒé™è¯´æ˜æ–‡æœ¬

```json
// resources/base/element/string.json
{
  "string": [
    {
      "name": "reason_internet",
      "value": "ç”¨äºè®¿é—®ç½‘ç»œè·å–æ•°æ®"
    },
    {
      "name": "reason_camera",
      "value": "ç”¨äºæ‹ç…§å’Œæ‰«ç åŠŸèƒ½"
    },
    {
      "name": "reason_location",
      "value": "ç”¨äºè·å–æ‚¨çš„ä½ç½®ä¿¡æ¯"
    }
  ]
}
```

## ğŸ™‹ åŠ¨æ€æƒé™ç”³è¯·

### æ£€æŸ¥å’Œè¯·æ±‚æƒé™

```typescript
import { abilityAccessCtrl, common, Permissions } from '@kit.AbilityKit'
import { BusinessError } from '@kit.BasicServicesKit'

class PermissionManager {
  private context: common.UIAbilityContext
  private atManager: abilityAccessCtrl.AtManager
  
  constructor(context: common.UIAbilityContext) {
    this.context = context
    this.atManager = abilityAccessCtrl.createAtManager()
  }
  
  // æ£€æŸ¥æƒé™
  async checkPermission(permission: Permissions): Promise<boolean> {
    try {
      const grantStatus = await this.atManager.checkAccessToken(
        this.context.applicationInfo.accessTokenId,
        permission
      )
      
      return grantStatus === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED
    } catch (err) {
      console.error('æ£€æŸ¥æƒé™å¤±è´¥:', err)
      return false
    }
  }
  
  // è¯·æ±‚æƒé™
  async requestPermission(permission: Permissions): Promise<boolean> {
    try {
      const data = await this.atManager.requestPermissionsFromUser(
        this.context,
        [permission]
      )
      
      return data.authResults[0] === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED
    } catch (err) {
      console.error('è¯·æ±‚æƒé™å¤±è´¥:', err)
      return false
    }
  }
  
  // æ‰¹é‡è¯·æ±‚æƒé™
  async requestPermissions(permissions: Permissions[]): Promise<boolean[]> {
    try {
      const data = await this.atManager.requestPermissionsFromUser(
        this.context,
        permissions
      )
      
      return data.authResults.map(result => 
        result === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED
      )
    } catch (err) {
      console.error('æ‰¹é‡è¯·æ±‚æƒé™å¤±è´¥:', err)
      return permissions.map(() => false)
    }
  }
  
  // æ£€æŸ¥å¹¶è¯·æ±‚æƒé™
  async checkAndRequest(permission: Permissions): Promise<boolean> {
    const hasPermission = await this.checkPermission(permission)
    
    if (hasPermission) {
      return true
    }
    
    return await this.requestPermission(permission)
  }
}
```

## ğŸ“· ä½¿ç”¨æƒé™

### ç›¸æœºæƒé™ç¤ºä¾‹

```typescript
@Entry
@Component
struct CameraPage {
  private permissionManager: PermissionManager = new PermissionManager(getContext(this))
  
  async openCamera() {
    // æ£€æŸ¥å¹¶è¯·æ±‚ç›¸æœºæƒé™
    const hasPermission = await this.permissionManager.checkAndRequest(
      'ohos.permission.CAMERA'
    )
    
    if (hasPermission) {
      // æ‰“å¼€ç›¸æœº
      this.startCamera()
    } else {
      // æƒé™è¢«æ‹’ç»
      promptAction.showToast({
        message: 'éœ€è¦ç›¸æœºæƒé™æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½'
      })
      
      // å¼•å¯¼ç”¨æˆ·å»è®¾ç½®
      this.openPermissionSettings()
    }
  }
  
  startCamera() {
    console.log('å¯åŠ¨ç›¸æœº')
    // ç›¸æœºé€»è¾‘
  }
  
  openPermissionSettings() {
    // æ‰“å¼€åº”ç”¨æƒé™è®¾ç½®é¡µé¢
    this.context.startAbility({
      bundleName: 'com.huawei.hmos.settings',
      abilityName: 'com.huawei.hmos.settings.MainAbility',
      uri: 'application_info_entry',
      parameters: {
        pushParams: this.context.abilityInfo.bundleName
      }
    })
  }
  
  build() {
    Column() {
      Button('æ‰“å¼€ç›¸æœº')
        .onClick(() => {
          this.openCamera()
        })
    }
  }
}
```

### ä½ç½®æƒé™ç¤ºä¾‹

```typescript
@Entry
@Component
struct LocationPage {
  private permissionManager: PermissionManager = new PermissionManager(getContext(this))
  @State location: string = ''
  
  async getLocation() {
    // è¯·æ±‚å¤šä¸ªä½ç½®ç›¸å…³æƒé™
    const permissions: Permissions[] = [
      'ohos.permission.APPROXIMATELY_LOCATION',
      'ohos.permission.LOCATION'
    ]
    
    const results = await this.permissionManager.requestPermissions(permissions)
    
    if (results.some(r => r)) {
      // è‡³å°‘æœ‰ä¸€ä¸ªæƒé™è¢«æˆäºˆ
      this.fetchLocation()
    } else {
      promptAction.showToast({
        message: 'éœ€è¦ä½ç½®æƒé™'
      })
    }
  }
  
  async fetchLocation() {
    // è·å–ä½ç½®ä¿¡æ¯
    this.location = 'åŒ—äº¬å¸‚æœé˜³åŒº'
  }
  
  build() {
    Column({ space: 20 }) {
      Text(this.location || 'æœªè·å–ä½ç½®')
        .fontSize(18)
      
      Button('è·å–ä½ç½®')
        .onClick(() => {
          this.getLocation()
        })
    }
    .padding(20)
  }
}
```

## ğŸ¯ å®æˆ˜æ¡ˆä¾‹ï¼šæƒé™ç®¡ç†å™¨

```typescript
@Entry
@Component
struct PermissionSettings {
  private permissionManager: PermissionManager = new PermissionManager(getContext(this))
  
  @State permissions: PermissionItem[] = [
    {
      name: 'ohos.permission.CAMERA',
      title: 'ç›¸æœº',
      description: 'ç”¨äºæ‹ç…§å’Œæ‰«ç ',
      granted: false
    },
    {
      name: 'ohos.permission.MICROPHONE',
      title: 'éº¦å…‹é£',
      description: 'ç”¨äºå½•éŸ³åŠŸèƒ½',
      granted: false
    },
    {
      name: 'ohos.permission.LOCATION',
      title: 'ä½ç½®',
      description: 'ç”¨äºå®šä½æœåŠ¡',
      granted: false
    },
    {
      name: 'ohos.permission.READ_MEDIA',
      title: 'å­˜å‚¨',
      description: 'ç”¨äºè¯»å–ç…§ç‰‡å’Œæ–‡ä»¶',
      granted: false
    }
  ]
  
  async aboutToAppear() {
    await this.checkAllPermissions()
  }
  
  async checkAllPermissions() {
    for (let permission of this.permissions) {
      permission.granted = await this.permissionManager.checkPermission(
        permission.name as Permissions
      )
    }
  }
  
  async togglePermission(permission: PermissionItem) {
    if (permission.granted) {
      // å·²æˆæƒï¼Œå¼•å¯¼ç”¨æˆ·å»è®¾ç½®å–æ¶ˆ
      this.openPermissionSettings()
    } else {
      // æœªæˆæƒï¼Œè¯·æ±‚æƒé™
      const granted = await this.permissionManager.requestPermission(
        permission.name as Permissions
      )
      
      permission.granted = granted
      
      if (!granted) {
        promptAction.showDialog({
          title: 'æƒé™è¢«æ‹’ç»',
          message: 'è¯¥åŠŸèƒ½éœ€è¦æ­¤æƒé™æ‰èƒ½ä½¿ç”¨ï¼Œæ˜¯å¦å‰å¾€è®¾ç½®ï¼Ÿ',
          buttons: [
            { text: 'å–æ¶ˆ' },
            { text: 'å»è®¾ç½®' }
          ]
        }).then((result) => {
          if (result.index === 1) {
            this.openPermissionSettings()
          }
        })
      }
    }
  }
  
  openPermissionSettings() {
    // æ‰“å¼€ç³»ç»Ÿè®¾ç½®
  }
  
  build() {
    Column() {
      Text('æƒé™ç®¡ç†')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .padding(20)
      
      List({ space: 10 }) {
        ForEach(this.permissions, (permission: PermissionItem) => {
          ListItem() {
            Row() {
              Column({ space: 5 }) {
                Text(permission.title)
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                
                Text(permission.description)
                  .fontSize(14)
                  .fontColor(Color.Gray)
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Start)
              
              Toggle({ type: ToggleType.Switch, isOn: permission.granted })
                .onChange((checked) => {
                  this.togglePermission(permission)
                })
            }
            .width('100%')
            .padding(15)
            .backgroundColor(Color.White)
            .borderRadius(8)
          }
        })
      }
      .layoutWeight(1)
      .padding({ left: 15, right: 15 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(0xF5F5F5)
  }
}

interface PermissionItem {
  name: string
  title: string
  description: string
  granted: boolean
}
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æŒ‰éœ€è¯·æ±‚

```typescript
// âœ… åœ¨ä½¿ç”¨åŠŸèƒ½å‰è¯·æ±‚
Button('æ‹ç…§')
  .onClick(async () => {
    const granted = await checkAndRequestPermission('ohos.permission.CAMERA')
    if (granted) {
      openCamera()
    }
  })

// âŒ é¿å…åœ¨å¯åŠ¨æ—¶è¯·æ±‚æ‰€æœ‰æƒé™
```

### 2. è¯´æ˜æƒé™ç”¨é€”

```typescript
// âœ… å…ˆè¯´æ˜ï¼Œå†è¯·æ±‚
AlertDialog.show({
  title: 'éœ€è¦ç›¸æœºæƒé™',
  message: 'ç”¨äºæ‰«æäºŒç»´ç å’Œæ‹ç…§åŠŸèƒ½',
  primaryButton: {
    value: 'å–æ¶ˆ'
  },
  secondaryButton: {
    value: 'æˆæƒ',
    action: () => {
      requestPermission('ohos.permission.CAMERA')
    }
  }
})
```

### 3. å¤„ç†æƒé™è¢«æ‹’ç»

```typescript
const granted = await requestPermission('ohos.permission.LOCATION')

if (!granted) {
  // æä¾›æ›¿ä»£æ–¹æ¡ˆæˆ–å¼•å¯¼
  promptAction.showDialog({
    message: 'æ²¡æœ‰ä½ç½®æƒé™ï¼Œæ˜¯å¦æ‰‹åŠ¨è¾“å…¥åŸå¸‚ï¼Ÿ'
  })
}
```

## ğŸ“š å‚è€ƒèµ„æº

- [æƒé™ç®¡ç†](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/accesstoken-overview-0000001820999637-V5)
- [æƒé™åˆ—è¡¨](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/permissions-for-all-0000001774121106-V5)

---

**ä¸‹ä¸€èŠ‚** â†’ [æ•°æ®åŠ å¯†ä¸å­˜å‚¨](02-æ•°æ®åŠ å¯†ä¸å­˜å‚¨.md)
