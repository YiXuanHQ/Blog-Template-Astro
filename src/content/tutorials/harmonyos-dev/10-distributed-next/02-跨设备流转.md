---
title: è·¨è®¾å¤‡æµè½¬
date: 2025-01-22
prevChapter: "harmonyos-dev/10-distributed-next/01-åˆ†å¸ƒå¼ç¡¬ä»¶è™šæ‹ŸåŒ–"
nextChapter: "harmonyos-dev/10-distributed-next/03-åˆ†å¸ƒå¼ç»„ä»¶"
parentChapter: "harmonyos-dev/10-distributed-next/README"
---
# è·¨è®¾å¤‡æµè½¬

> å®ç°åº”ç”¨è·¨è®¾å¤‡æ— ç¼è¿ç§»

## ğŸ”„ æµè½¬æ¦‚è¿°

### ä»€ä¹ˆæ˜¯æµè½¬

åº”ç”¨ä»ä¸€ä¸ªè®¾å¤‡è¿ç§»åˆ°å¦ä¸€ä¸ªè®¾å¤‡ï¼Œä¿æŒçŠ¶æ€å’Œæ•°æ®çš„è¿ç»­æ€§ã€‚

```
æµè½¬åœºæ™¯
â”œâ”€ æ‰‹æœº â†’ å¹³æ¿ï¼ˆçœ‹è§†é¢‘æ¢å¤§å±ï¼‰
â”œâ”€ å¹³æ¿ â†’ æ‰‹æœºï¼ˆå¤–å‡ºç»§ç»­ä½¿ç”¨ï¼‰
â”œâ”€ æ‰‹æœº â†’ PCï¼ˆåŠå…¬æ›´é«˜æ•ˆï¼‰
â””â”€ PC â†’ æ‰‹æœºï¼ˆéšæ—¶éšåœ°ï¼‰
```

## ğŸ¯ UIAbility è¿ç§»

### é…ç½®è¿ç§»èƒ½åŠ›

```json5
// module.json5
{
  "abilities": [
    {
      "name": "MainAbility",
      "continuable": true  // å¯ç”¨æµè½¬èƒ½åŠ›
    }
  ]
}
```

### å®ç°è¿ç§»æ¥å£

```typescript
import UIAbility from '@ohos.app.ability.UIAbility'
import AbilityConstant from '@ohos.app.ability.AbilityConstant'

export default class MainAbility extends UIAbility {
  // ä¿å­˜çŠ¶æ€ï¼ˆè¿ç§»å‰ï¼‰
  onContinue(wantParam: Record<string, Object>): AbilityConstant.OnContinueResult {
    console.log('å‡†å¤‡è¿ç§»')
    
    // ä¿å­˜åº”ç”¨çŠ¶æ€
    wantParam['currentPage'] = 'DetailPage'
    wantParam['scrollPosition'] = 120
    wantParam['videoProgress'] = 58.5
    wantParam['formData'] = JSON.stringify({
      username: 'Alice',
      content: 'æœªå®Œæˆçš„è¾“å…¥'
    })
    
    // è¿”å›åŒæ„è¿ç§»
    return AbilityConstant.OnContinueResult.AGREE
  }
  
  // æ¢å¤çŠ¶æ€ï¼ˆè¿ç§»åï¼‰
  onCreate(want, launchParam) {
    if (launchParam.launchReason === AbilityConstant.LaunchReason.CONTINUATION) {
      console.log('ä»å…¶ä»–è®¾å¤‡è¿ç§»è€Œæ¥')
      
      // æ¢å¤çŠ¶æ€
      const currentPage = want.parameters?.currentPage
      const scrollPosition = want.parameters?.scrollPosition
      const videoProgress = want.parameters?.videoProgress
      const formData = JSON.parse(want.parameters?.formData || '{}')
      
      // åº”ç”¨çŠ¶æ€
      AppStorage.SetOrCreate('currentPage', currentPage)
      AppStorage.SetOrCreate('scrollPosition', scrollPosition)
      AppStorage.SetOrCreate('videoProgress', videoProgress)
      AppStorage.SetOrCreate('formData', formData)
    }
  }
}
```

## ğŸ“¦ æ•°æ®è¿ç§»

### è¿ç§»ç”¨æˆ·æ•°æ®

```typescript
export default class VideoPlayerAbility extends UIAbility {
  private player: VideoPlayer
  
  onContinue(wantParam) {
    // è·å–å½“å‰æ’­æ”¾çŠ¶æ€
    const currentTime = this.player.getCurrentTime()
    const duration = this.player.getDuration()
    const videoUrl = this.player.getVideoUrl()
    
    // ä¿å­˜åˆ°è¿ç§»å‚æ•°
    wantParam['videoUrl'] = videoUrl
    wantParam['currentTime'] = currentTime
    wantParam['duration'] = duration
    wantParam['isPlaying'] = this.player.isPlaying()
    
    return AbilityConstant.OnContinueResult.AGREE
  }
  
  onCreate(want, launchParam) {
    if (launchParam.launchReason === AbilityConstant.LaunchReason.CONTINUATION) {
      // æ¢å¤æ’­æ”¾å™¨
      const videoUrl = want.parameters?.videoUrl
      const currentTime = want.parameters?.currentTime
      
      this.player.load(videoUrl)
      this.player.seekTo(currentTime)
      
      if (want.parameters?.isPlaying) {
        this.player.play()
      }
    }
  }
}
```

### è¿ç§»å¤§æ•°æ®

```typescript
import distributedKVStore from '@ohos.data.distributedKVStore'

class DataMigrationHelper {
  private kvStore: distributedKVStore.SingleKVStore
  
  async init() {
    const kvManager = distributedKVStore.createKVManager({
      context: context,
      bundleName: 'com.example.app'
    })
    
    this.kvStore = await kvManager.getKVStore('migrationStore', {
      createIfMissing: true,
      autoSync: true
    })
  }
  
  // ä¿å­˜æ•°æ®åˆ°åˆ†å¸ƒå¼å­˜å‚¨
  async saveForMigration(data: any) {
    const key = 'migration_data'
    await this.kvStore.put(key, JSON.stringify(data))
  }
  
  // ä»åˆ†å¸ƒå¼å­˜å‚¨è¯»å–
  async loadFromMigration(): Promise<any> {
    const key = 'migration_data'
    const value = await this.kvStore.get(key)
    return JSON.parse(value)
  }
}

// ä½¿ç”¨
export default class DocumentEditorAbility extends UIAbility {
  private migrationHelper: DataMigrationHelper
  
  async onContinue(wantParam) {
    // ä¿å­˜å¤§é‡æ•°æ®åˆ°åˆ†å¸ƒå¼å­˜å‚¨
    await this.migrationHelper.saveForMigration({
      document: this.currentDocument,
      editHistory: this.editHistory,
      cursorPosition: this.cursorPosition
    })
    
    // åªä¼ é€’æ•°æ®æ ‡è¯†
    wantParam['dataKey'] = 'migration_data'
    
    return AbilityConstant.OnContinueResult.AGREE
  }
  
  async onCreate(want, launchParam) {
    if (launchParam.launchReason === AbilityConstant.LaunchReason.CONTINUATION) {
      // ä»åˆ†å¸ƒå¼å­˜å‚¨æ¢å¤æ•°æ®
      const data = await this.migrationHelper.loadFromMigration()
      
      this.currentDocument = data.document
      this.editHistory = data.editHistory
      this.cursorPosition = data.cursorPosition
    }
  }
}
```

## ğŸ® å®æˆ˜æ¡ˆä¾‹ï¼šè§†é¢‘æ’­æ”¾å™¨æµè½¬

```typescript
@Entry
@Component
struct VideoPlayer {
  @StorageLink('videoUrl') videoUrl: string = ''
  @StorageLink('currentTime') currentTime: number = 0
  @StorageLink('isPlaying') isPlaying: boolean = false
  
  private videoController: VideoController = new VideoController()
  
  aboutToAppear() {
    // å¦‚æœæ˜¯è¿ç§»è¿‡æ¥çš„ï¼Œæ¢å¤æ’­æ”¾çŠ¶æ€
    if (this.videoUrl && this.currentTime > 0) {
      this.videoController.setCurrentTime(this.currentTime)
      
      if (this.isPlaying) {
        this.videoController.start()
      }
    }
  }
  
  build() {
    Column() {
      Video({
        src: this.videoUrl,
        controller: this.videoController
      })
      .width('100%')
      .height(300)
      .onUpdate((event) => {
        // å®æ—¶æ›´æ–°æ’­æ”¾è¿›åº¦
        this.currentTime = event.time
      })
      
      Row({ space: 20 }) {
        Button(this.isPlaying ? 'æš‚åœ' : 'æ’­æ”¾')
          .onClick(() => {
            if (this.isPlaying) {
              this.videoController.pause()
            } else {
              this.videoController.start()
            }
            this.isPlaying = !this.isPlaying
          })
        
        Text(`${this.formatTime(this.currentTime)}`)
      }
      .margin({ top: 20 })
    }
    .padding(20)
  }
  
  formatTime(seconds: number): string {
    const min = Math.floor(seconds / 60)
    const sec = Math.floor(seconds % 60)
    return `${min}:${sec.toString().padStart(2, '0')}`
  }
}

// Ability
export default class VideoPlayerAbility extends UIAbility {
  onContinue(wantParam) {
    // è·å–å½“å‰çŠ¶æ€
    const videoUrl = AppStorage.Get('videoUrl')
    const currentTime = AppStorage.Get('currentTime')
    const isPlaying = AppStorage.Get('isPlaying')
    
    // ä¿å­˜åˆ°è¿ç§»å‚æ•°
    wantParam['videoUrl'] = videoUrl
    wantParam['currentTime'] = currentTime
    wantParam['isPlaying'] = isPlaying
    
    return AbilityConstant.OnContinueResult.AGREE
  }
  
  onCreate(want, launchParam) {
    if (launchParam.launchReason === AbilityConstant.LaunchReason.CONTINUATION) {
      // æ¢å¤çŠ¶æ€
      AppStorage.SetOrCreate('videoUrl', want.parameters?.videoUrl)
      AppStorage.SetOrCreate('currentTime', want.parameters?.currentTime)
      AppStorage.SetOrCreate('isPlaying', want.parameters?.isPlaying)
    }
    
    super.onCreate(want, launchParam)
  }
}
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. åªè¿ç§»å¿…è¦æ•°æ®

```typescript
// âœ… åªä¿å­˜å…³é”®çŠ¶æ€
wantParam['videoId'] = this.videoId
wantParam['progress'] = this.progress

// âŒ é¿å…ä¿å­˜å¤§æ•°æ®
// wantParam['videoData'] = this.videoBuffer  // å¤ªå¤§
```

### 2. ä½¿ç”¨åˆ†å¸ƒå¼å­˜å‚¨

```typescript
// å¤§æ•°æ®æ”¾åˆ†å¸ƒå¼å­˜å‚¨
await kvStore.put('largeData', data)

// åªä¼ é€’å¼•ç”¨
wantParam['dataKey'] = 'largeData'
```

### 3. å¤„ç†è¿ç§»å¤±è´¥

```typescript
onContinue(wantParam) {
  try {
    // ä¿å­˜çŠ¶æ€
    wantParam['data'] = this.getData()
    return AbilityConstant.OnContinueResult.AGREE
  } catch (err) {
    console.error('è¿ç§»å‡†å¤‡å¤±è´¥:', err)
    return AbilityConstant.OnContinueResult.REJECT
  }
}
```

## ğŸ“š å‚è€ƒèµ„æº

- [è·¨ç«¯è¿ç§»](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/hop-cross-device-migration-0000001821000453-V5)

---

**ä¸‹ä¸€èŠ‚** â†’ [åˆ†å¸ƒå¼ç»„ä»¶](03-åˆ†å¸ƒå¼ç»„ä»¶.md)
