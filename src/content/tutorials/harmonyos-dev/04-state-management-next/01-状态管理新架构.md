---
title: ---
---

---
title: 状态管理新架构
date: 2025-01-22
---

# 状态管理新架构

> HarmonyOS NEXT 状态管理的革新

## 🔄 状态管理演进

### 版本对比

| 版本 | 状态管理方案 | 特点 |
|------|------------|------|
| HarmonyOS 4.0 | @Observed + @ObjectLink | 整体监听，性能一般 |
| HarmonyOS NEXT | @ObservedV2 + @Trace | 细粒度监听，性能优异 ⭐ |

## 🎯 新架构核心概念

### 细粒度监听

```typescript
// 旧版本 - 整体监听
@Observed
class UserInfo {
  name: string = ''
  age: number = 0
  city: string = ''
}
// 任何属性变化都会触发整个对象的更新

// 新版本 - 细粒度监听
@ObservedV2
class UserInfo {
  @Trace name: string = ''      // 只监听 name
  @Trace age: number = 0         // 只监听 age
  city: string = ''              // 不监听
}
// 只有被 @Trace 标记的属性变化才会更新
```

### 性能对比

```
更新 10000 次测试：
├─ @Observed（旧版）: 1200ms
└─ @ObservedV2 + @Trace（新版）: 300ms
性能提升：75%
```

## 📦 @ObservedV2 详解

### 基本用法

```typescript
@ObservedV2
class Product {
  @Trace name: string = ''
  @Trace price: number = 0
  @Trace stock: number = 0
  description: string = ''  // 不监听变化
  
  // 计算属性
  get totalValue(): number {
    return this.price * this.stock
  }
}

@Entry
@Component
struct ProductPage {
  @Local product: Product = new Product()
  
  aboutToAppear() {
    this.product.name = 'iPhone 15'
    this.product.price = 5999
    this.product.stock = 100
  }
  
  build() {
    Column({ space: 20 }) {
      Text(`商品: ${this.product.name}`)
      Text(`价格: ¥${this.product.price}`)
      Text(`库存: ${this.product.stock}`)
      Text(`总价值: ¥${this.product.totalValue}`)
      
      Button('减少库存')
        .onClick(() => {
          this.product.stock--  // UI 自动更新
        })
      
      Button('修改描述')
        .onClick(() => {
          this.product.description = '新描述'  // UI 不更新
        })
    }
    .padding(20)
  }
}
```

### 嵌套对象

```typescript
@ObservedV2
class Address {
  @Trace city: string = ''
  @Trace street: string = ''
}

@ObservedV2
class User {
  @Trace name: string = ''
  @Trace age: number = 0
  @Trace address: Address = new Address()  // 嵌套对象
}

@Entry
@Component
struct UserProfile {
  @Local user: User = new User()
  
  build() {
    Column({ space: 10 }) {
      Text(`姓名: ${this.user.name}`)
      Text(`年龄: ${this.user.age}`)
      Text(`城市: ${this.user.address.city}`)
      Text(`街道: ${this.user.address.street}`)
      
      Button('修改地址')
        .onClick(() => {
          this.user.address.city = '北京'
          this.user.address.street = '中关村大街'
        })
    }
    .padding(20)
  }
}
```

### 数组和集合

```typescript
@ObservedV2
class TodoList {
  @Trace items: string[] = []
  
  addItem(item: string) {
    this.items.push(item)  // 触发更新
  }
  
  removeItem(index: number) {
    this.items.splice(index, 1)  // 触发更新
  }
}

@Entry
@Component
struct TodoApp {
  @Local todoList: TodoList = new TodoList()
  @State newItem: string = ''
  
  build() {
    Column({ space: 20 }) {
      Row({ space: 10 }) {
        TextInput({ placeholder: '新任务' })
          .onChange((value) => {
            this.newItem = value
          })
        
        Button('添加')
          .onClick(() => {
            if (this.newItem) {
              this.todoList.addItem(this.newItem)
              this.newItem = ''
            }
          })
      }
      
      List({ space: 10 }) {
        ForEach(this.todoList.items, (item: string, index: number) => {
          ListItem() {
            Row() {
              Text(item)
                .layoutWeight(1)
              
              Button('删除')
                .onClick(() => {
                  this.todoList.removeItem(index)
                })
            }
            .width('100%')
            .padding(10)
            .backgroundColor(Color.White)
          }
        }, (item: string, index: number) => `${index}-${item}`)
      }
    }
    .padding(20)
  }
}
```

## 🔗 @Local 装饰器

### 本地状态管理

```typescript
@Entry
@Component
struct LocalExample {
  @Local counter: number = 0
  @Local user: User = new User()
  
  // @Local 用于组件内部状态
  // 不会传递给子组件
  
  build() {
    Column() {
      Text(`Counter: ${this.counter}`)
      Button('增加')
        .onClick(() => {
          this.counter++
        })
    }
  }
}
```

### 与 @State 的区别

```typescript
@Entry
@Component
struct ComparisonExample {
  // @State - 可以传递给子组件
  @State stateValue: number = 0
  
  // @Local - 仅组件内部使用
  @Local localValue: number = 0
  
  build() {
    Column() {
      // ✅ 可以传递 @State
      ChildComponent({ value: this.stateValue })
      
      // ❌ 不能传递 @Local
      // ChildComponent({ value: this.localValue })
    }
  }
}
```

## 📊 状态管理最佳实践

### 1. 合理选择装饰器

```typescript
// ✅ 简单数据用 @State
@Entry
@Component
struct SimpleState {
  @State count: number = 0
  @State message: string = ''
}

// ✅ 复杂对象用 @ObservedV2
@ObservedV2
class ComplexData {
  @Trace field1: string = ''
  @Trace field2: number = 0
}

@Entry
@Component
struct ComplexState {
  @Local data: ComplexData = new ComplexData()
}
```

### 2. 最小化监听范围

```typescript
// ✅ 只监听需要的属性
@ObservedV2
class User {
  @Trace name: string = ''        // UI 需要显示
  @Trace avatar: string = ''      // UI 需要显示
  id: number = 0                  // 不需要监听
  createdAt: Date = new Date()    // 不需要监听
}

// ❌ 避免过度监听
@ObservedV2
class User {
  @Trace id: number = 0           // 不必要
  @Trace createdAt: Date = new Date()  // 不必要
}
```

### 3. 状态提升

```typescript
// ✅ 将共享状态提升到父组件
@Entry
@Component
struct Parent {
  @State sharedData: string = ''
  
  build() {
    Column() {
      ChildA({ data: this.sharedData })
      ChildB({ data: this.sharedData })
    }
  }
}

@Component
struct ChildA {
  @Prop data: string
  
  build() {
    Text(this.data)
  }
}

@Component
struct ChildB {
  @Prop data: string
  
  build() {
    Text(this.data)
  }
}
```

### 4. 避免循环依赖

```typescript
// ❌ 避免
@ObservedV2
class A {
  @Trace b: B = new B()
}

@ObservedV2
class B {
  @Trace a: A = new A()  // 循环依赖
}

// ✅ 使用接口解耦
interface IDataProvider {
  getData(): string
}

@ObservedV2
class A implements IDataProvider {
  @Trace value: string = ''
  
  getData(): string {
    return this.value
  }
}
```

## 🎯 实战案例

### 购物车示例

```typescript
@ObservedV2
class CartItem {
  @Trace id: number = 0
  @Trace name: string = ''
  @Trace price: number = 0
  @Trace quantity: number = 1
  
  get total(): number {
    return this.price * this.quantity
  }
}

@ObservedV2
class ShoppingCart {
  @Trace items: CartItem[] = []
  
  get totalAmount(): number {
    return this.items.reduce((sum, item) => sum + item.total, 0)
  }
  
  addItem(item: CartItem) {
    const existing = this.items.find(i => i.id === item.id)
    if (existing) {
      existing.quantity++
    } else {
      this.items.push(item)
    }
  }
  
  removeItem(id: number) {
    const index = this.items.findIndex(i => i.id === id)
    if (index >= 0) {
      this.items.splice(index, 1)
    }
  }
  
  updateQuantity(id: number, quantity: number) {
    const item = this.items.find(i => i.id === id)
    if (item) {
      item.quantity = quantity
    }
  }
}

@Entry
@Component
struct ShoppingCartPage {
  @Local cart: ShoppingCart = new ShoppingCart()
  
  aboutToAppear() {
    // 初始化购物车
    this.cart.addItem({
      id: 1,
      name: 'iPhone 15',
      price: 5999,
      quantity: 1
    } as CartItem)
  }
  
  build() {
    Column() {
      // 标题栏
      Row() {
        Text('购物车')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
        
        Text(`共 ${this.cart.items.length} 件`)
          .fontSize(16)
          .fontColor(Color.Gray)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .padding(20)
      
      // 商品列表
      List({ space: 10 }) {
        ForEach(this.cart.items, (item: CartItem) => {
          ListItem() {
            Row({ space: 10 }) {
              Column({ space: 5 }) {
                Text(item.name)
                  .fontSize(16)
                Text(`¥${item.price}`)
                  .fontSize(14)
                  .fontColor(Color.Red)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              
              Row({ space: 10 }) {
                Button('-')
                  .width(30)
                  .height(30)
                  .onClick(() => {
                    if (item.quantity > 1) {
                      this.cart.updateQuantity(item.id, item.quantity - 1)
                    }
                  })
                
                Text(`${item.quantity}`)
                  .width(40)
                  .textAlign(TextAlign.Center)
                
                Button('+')
                  .width(30)
                  .height(30)
                  .onClick(() => {
                    this.cart.updateQuantity(item.id, item.quantity + 1)
                  })
              }
              
              Button('删除')
                .onClick(() => {
                  this.cart.removeItem(item.id)
                })
            }
            .width('100%')
            .padding(15)
            .backgroundColor(Color.White)
            .borderRadius(8)
          }
        }, (item: CartItem) => `${item.id}`)
      }
      .layoutWeight(1)
      .padding({ left: 20, right: 20 })
      
      // 底部结算
      Row() {
        Column({ space: 5 }) {
          Text('合计')
            .fontSize(14)
            .fontColor(Color.Gray)
          Text(`¥${this.cart.totalAmount}`)
            .fontSize(24)
            .fontColor(Color.Red)
            .fontWeight(FontWeight.Bold)
        }
        .alignItems(HorizontalAlign.Start)
        
        Button('去结算')
          .width(120)
          .height(50)
          .onClick(() => {
            console.log('结算')
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .padding(20)
      .backgroundColor(Color.White)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
```

## 📚 参考资源

- [状态管理官方文档](https://developer.harmonyos.com/cn/docs/documentation/doc-guides-V3/arkts-state-management-0000001524537145-V3)
- [@ObservedV2 API](https://developer.harmonyos.com/cn/docs/documentation/doc-references-V3/ts-state-management-0000001478061717-V3)

---

**下一节** → [@ObservedV2 与 @Trace](02-@ObservedV2与@Trace.md)
