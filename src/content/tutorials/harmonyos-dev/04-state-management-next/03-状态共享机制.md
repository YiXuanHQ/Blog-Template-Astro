---
title: ---
---

---
title: 状态共享机制
date: 2025-01-22
---

# 状态共享机制

> 跨组件、跨页面的状态管理

## 🔗 @Provide / @Consume

### 基础用法

```typescript
// 祖先组件 - 提供状态
@Entry
@Component
struct GrandParent {
  @Provide('theme') theme: string = 'light'
  @Provide('fontSize') fontSize: number = 16
  
  build() {
    Column() {
      Text('祖先组件')
        .fontSize(this.fontSize)
      
      Parent()  // 不需要传递 props
      
      Button('切换主题')
        .onClick(() => {
          this.theme = this.theme === 'light' ? 'dark' : 'light'
        })
    }
  }
}

// 中间组件 - 透传
@Component
struct Parent {
  build() {
    Column() {
      Text('父组件')
      Child()  // 不需要传递 props
    }
  }
}

// 后代组件 - 消费状态
@Component
struct Child {
  @Consume('theme') theme: string
  @Consume('fontSize') fontSize: number
  
  build() {
    Column() {
      Text(`当前主题: ${this.theme}`)
        .fontSize(this.fontSize)
        .backgroundColor(this.theme === 'light' ? Color.White : Color.Black)
        .fontColor(this.theme === 'light' ? Color.Black : Color.White)
    }
  }
}
```

### 应用场景

```typescript
// 全局主题管理
@Entry
@Component
struct App {
  @Provide('themeConfig') themeConfig: ThemeConfig = {
    primaryColor: '#007DFF',
    backgroundColor: '#FFFFFF',
    textColor: '#000000'
  }
  
  build() {
    Navigation() {
      HomePage()
    }
  }
}

// 任意深层组件都可以访问
@Component
struct DeepComponent {
  @Consume('themeConfig') themeConfig: ThemeConfig
  
  build() {
    Text('深层组件')
      .fontColor(this.themeConfig.textColor)
      .backgroundColor(this.themeConfig.backgroundColor)
  }
}
```

## 💾 LocalStorage

### 页面级存储

```typescript
// 创建 LocalStorage 实例
const storage = new LocalStorage({
  'count': 0,
  'message': 'Hello'
})

@Entry(storage)
@Component
struct PageA {
  @LocalStorageLink('count') count: number = 0
  @LocalStorageProp('message') message: string = ''
  
  build() {
    Column({ space: 15 }) {
      Text(`Count: ${this.count}`)
      Text(`Message: ${this.message}`)
      
      Button('增加')
        .onClick(() => {
          this.count++  // 更新 LocalStorage
        })
    }
  }
}

// 同一个 storage 实例的其他组件也会同步更新
@Component
struct PageB {
  @LocalStorageLink('count') count: number = 0
  
  build() {
    Text(`PageB Count: ${this.count}`)
  }
}
```

### @LocalStorageLink vs @LocalStorageProp

```typescript
@Entry(storage)
@Component
struct StorageExample {
  // @LocalStorageLink - 双向绑定
  @LocalStorageLink('username') username: string = ''
  
  // @LocalStorageProp - 单向绑定（只读）
  @LocalStorageProp('appVersion') appVersion: string = ''
  
  build() {
    Column({ space: 15 }) {
      // 可以修改 username（双向）
      TextInput({ text: this.username })
        .onChange((value) => {
          this.username = value  // ✅ 更新到 storage
        })
      
      // 不能修改 appVersion（单向）
      Text(`版本: ${this.appVersion}`)
      
      Button('尝试修改版本')
        .onClick(() => {
          // this.appVersion = '2.0'  // ❌ 编译错误
        })
    }
  }
}
```

## 🌐 AppStorage

### 应用级存储

```typescript
// 初始化全局状态
AppStorage.SetOrCreate('userInfo', {
  name: 'Guest',
  isLogin: false
})

AppStorage.SetOrCreate('cartCount', 0)

// 任意组件访问
@Entry
@Component
struct HomePage {
  @StorageLink('userInfo') userInfo: UserInfo
  @StorageLink('cartCount') cartCount: number
  
  build() {
    Column({ space: 15 }) {
      Text(`欢迎, ${this.userInfo.name}`)
      
      if (!this.userInfo.isLogin) {
        Button('登录')
          .onClick(() => {
            this.userInfo = {
              name: 'Alice',
              isLogin: true
            }
          })
      }
      
      Button(`购物车 (${this.cartCount})`)
        .onClick(() => {
          this.cartCount++
        })
    }
  }
}

// 其他页面也能访问
@Component
struct ProfilePage {
  @StorageLink('userInfo') userInfo: UserInfo
  
  build() {
    Column() {
      if (this.userInfo.isLogin) {
        Text(`用户: ${this.userInfo.name}`)
        
        Button('退出登录')
          .onClick(() => {
            this.userInfo = {
              name: 'Guest',
              isLogin: false
            }
          })
      }
    }
  }
}
```

### @StorageLink vs @StorageProp

```typescript
@Entry
@Component
struct AppStorageExample {
  // @StorageLink - 双向同步
  @StorageLink('globalCount') globalCount: number = 0
  
  // @StorageProp - 单向同步
  @StorageProp('appName') appName: string = ''
  
  build() {
    Column({ space: 15 }) {
      Button(`Global Count: ${this.globalCount}`)
        .onClick(() => {
          this.globalCount++  // ✅ 同步到 AppStorage
        })
      
      Text(`App Name: ${this.appName}`)  // 只读
    }
  }
}
```

## 💿 PersistentStorage

### 持久化存储

```typescript
// 持久化到磁盘
PersistentStorage.PersistProp('userSettings', {
  theme: 'light',
  language: 'zh-CN',
  notifications: true
})

PersistentStorage.PersistProp('lastVisit', Date.now())

@Entry
@Component
struct SettingsPage {
  @StorageLink('userSettings') settings: UserSettings
  
  build() {
    Column({ space: 15 }) {
      Row() {
        Text('主题')
        Toggle({ type: ToggleType.Switch, isOn: this.settings.theme === 'dark' })
          .onChange((checked) => {
            this.settings = {
              ...this.settings,
              theme: checked ? 'dark' : 'light'
            }
          })
      }
      
      Row() {
        Text('语言')
        Select([
          { value: '中文', data: 'zh-CN' },
          { value: 'English', data: 'en-US' }
        ])
        .selected(this.settings.language === 'zh-CN' ? 0 : 1)
        .onSelect((index) => {
          this.settings = {
            ...this.settings,
            language: index === 0 ? 'zh-CN' : 'en-US'
          }
        })
      }
      
      Text('设置会自动保存到本地')
        .fontSize(12)
        .fontColor(Color.Gray)
    }
    .padding(20)
  }
}
```

## 🎯 实战案例

### 用户认证状态管理

```typescript
// 定义用户状态
interface AuthState {
  isAuthenticated: boolean
  user: User | null
  token: string
}

// 初始化并持久化
PersistentStorage.PersistProp('authState', {
  isAuthenticated: false,
  user: null,
  token: ''
})

// 登录页面
@Entry
@Component
struct LoginPage {
  @StorageLink('authState') authState: AuthState
  @State username: string = ''
  @State password: string = ''
  
  async login() {
    try {
      const response = await authService.login(this.username, this.password)
      
      // 更新全局认证状态
      this.authState = {
        isAuthenticated: true,
        user: response.user,
        token: response.token
      }
      
      // 跳转到首页
      router.pushUrl({ url: 'pages/Home' })
    } catch (error) {
      console.error('登录失败:', error)
    }
  }
  
  build() {
    Column({ space: 20 }) {
      TextInput({ placeholder: '用户名' })
        .onChange((value) => {
          this.username = value
        })
      
      TextInput({ placeholder: '密码' })
        .type(InputType.Password)
        .onChange((value) => {
          this.password = value
        })
      
      Button('登录')
        .onClick(() => {
          this.login()
        })
    }
    .padding(20)
  }
}

// 首页 - 自动同步认证状态
@Entry
@Component
struct HomePage {
  @StorageLink('authState') authState: AuthState
  
  aboutToAppear() {
    // 检查认证状态
    if (!this.authState.isAuthenticated) {
      router.replaceUrl({ url: 'pages/Login' })
    }
  }
  
  logout() {
    this.authState = {
      isAuthenticated: false,
      user: null,
      token: ''
    }
    router.replaceUrl({ url: 'pages/Login' })
  }
  
  build() {
    Column() {
      if (this.authState.user) {
        Text(`欢迎, ${this.authState.user.name}`)
        
        Button('退出登录')
          .onClick(() => {
            this.logout()
          })
      }
    }
  }
}
```

### 购物车状态管理

```typescript
// 购物车状态
interface CartState {
  items: CartItem[]
  totalPrice: number
  totalItems: number
}

// 初始化
AppStorage.SetOrCreate('cart', {
  items: [],
  totalPrice: 0,
  totalItems: 0
})

// 商品列表页
@Entry
@Component
struct ProductList {
  @StorageLink('cart') cart: CartState
  @State products: Product[] = []
  
  addToCart(product: Product) {
    const existingItem = this.cart.items.find(item => item.id === product.id)
    
    if (existingItem) {
      existingItem.quantity++
    } else {
      this.cart.items.push({
        id: product.id,
        name: product.name,
        price: product.price,
        quantity: 1
      })
    }
    
    // 更新汇总
    this.updateCartSummary()
  }
  
  updateCartSummary() {
    this.cart = {
      ...this.cart,
      totalItems: this.cart.items.reduce((sum, item) => sum + item.quantity, 0),
      totalPrice: this.cart.items.reduce((sum, item) => sum + item.price * item.quantity, 0)
    }
  }
  
  build() {
    Column() {
      List() {
        ForEach(this.products, (product: Product) => {
          ListItem() {
            Row() {
              Text(product.name)
                .layoutWeight(1)
              Text(`¥${product.price}`)
              Button('加入购物车')
                .onClick(() => {
                  this.addToCart(product)
                })
            }
          }
        })
      }
      
      // 显示购物车汇总
      Text(`购物车: ${this.cart.totalItems} 件`)
    }
  }
}

// 购物车页面 - 自动同步
@Entry
@Component
struct CartPage {
  @StorageLink('cart') cart: CartState
  
  build() {
    Column() {
      List() {
        ForEach(this.cart.items, (item: CartItem) => {
          ListItem() {
            Row() {
              Text(item.name)
              Text(`¥${item.price} x ${item.quantity}`)
            }
          }
        })
      }
      
      Text(`总价: ¥${this.cart.totalPrice}`)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
    }
  }
}
```

## 💡 选择合适的存储方案

| 存储方案 | 适用场景 | 生命周期 |
|---------|---------|---------|
| **@Provide/@Consume** | 组件树内共享 | 组件生命周期 |
| **LocalStorage** | 页面内共享 | 页面生命周期 |
| **AppStorage** | 应用内共享 | 应用生命周期 |
| **PersistentStorage** | 需要持久化 | 永久保存 |

## 📚 参考资源

- [状态管理官方文档](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-state-management-overview-0000001820879537-V5)

---

**下一节** → [数据流管理](04-数据流管理.md)
